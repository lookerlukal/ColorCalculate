<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ€å¤§å…‰é€šé‡è®¡ç®—è¿‡ç¨‹æ¼”ç¤º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Microsoft YaHei", Arial, sans-serif;
            line-height: 1.8;
            color: #333;
            background-color: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        
        h2 {
            color: #34495e;
            margin-top: 30px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }
        
        h3 {
            color: #7f8c8d;
            margin-top: 20px;
            margin-bottom: 15px;
        }
        
        .input-section {
            background-color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .input-group {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .color-input {
            flex: 1;
            min-width: 250px;
            padding: 15px;
            background-color: white;
            border-radius: 5px;
            border: 2px solid transparent;
        }
        
        .color-input.red {
            border-color: #e74c3c;
        }
        
        .color-input.green {
            border-color: #27ae60;
        }
        
        .color-input.blue {
            border-color: #3498db;
        }
        
        .color-input.target {
            border-color: #9b59b6;
        }
        
        .color-input h4 {
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .input-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 10px;
        }
        
        label {
            display: inline-block;
            width: 100px;
            font-weight: bold;
        }
        
        input[type="number"] {
            width: 120px;
            padding: 5px 10px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 16px;
        }
        
        input[type="number"]:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .calculate-btn {
            display: block;
            width: 300px;
            margin: 30px auto;
            padding: 15px;
            background-color: #3498db;
            color: white;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .calculate-btn:hover {
            background-color: #2980b9;
        }
        
        .step-section {
            margin-bottom: 40px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            display: none;
        }
        
        .step-section.active {
            display: block;
        }
        
        .explanation {
            background-color: #e8f5ff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 16px;
            line-height: 1.8;
        }
        
        .formula {
            background-color: #fff;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 15px 0;
            font-family: "Courier New", monospace;
            font-size: 14px;
            overflow-x: auto;
        }
        
        .matrix {
            display: inline-block;
            vertical-align: middle;
            margin: 0 10px;
        }
        
        .matrix-bracket {
            display: inline-block;
            vertical-align: middle;
            font-size: 40px;
            font-weight: 100;
        }
        
        .matrix-content {
            display: inline-block;
            vertical-align: middle;
        }
        
        .matrix-row {
            display: block;
            text-align: center;
            margin: 5px 0;
        }
        
        .matrix-cell {
            display: inline-block;
            width: 80px;
            text-align: center;
            padding: 0 5px;
        }
        
        .result-box {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            font-weight: bold;
        }
        
        .error-box {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            color: #721c24;
            display: none;
        }
        
        .highlight {
            background-color: #fff3cd;
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: bold;
        }
        
        .small-text {
            font-size: 14px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        th, td {
            padding: 10px;
            text-align: center;
            border: 1px solid #ddd;
        }
        
        th {
            background-color: #3498db;
            color: white;
            font-weight: bold;
        }
        
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        .warning {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .success {
            color: #27ae60;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>æœ€å¤§å…‰é€šé‡è®¡ç®—è¿‡ç¨‹è¯¦ç»†æ¼”ç¤º</h1>
        
        <div class="input-section">
            <h2>ç¬¬ä¸€æ­¥ï¼šè¾“å…¥æ•°æ®</h2>
            <div class="explanation">
                è¯·è¾“å…¥RGBä¸‰åŸºè‰²çš„è‰²åæ ‡(x, y)å’Œæœ€å¤§å…‰é€šé‡é™åˆ¶ï¼Œä»¥åŠç›®æ ‡è‰²çš„è‰²åæ ‡ã€‚
                è‰²åæ ‡èŒƒå›´ä¸º0åˆ°1ä¹‹é—´ï¼Œå…‰é€šé‡ä¸ºæ­£æ•°ã€‚
            </div>
            
            <div class="input-group">
                <div class="color-input red">
                    <h4>ğŸ”´ çº¢è‰² (R)</h4>
                    <div class="input-row">
                        <label>xåæ ‡:</label>
                        <input type="number" id="red-x" step="0.0001" min="0" max="1" value="0.7">
                    </div>
                    <div class="input-row">
                        <label>yåæ ‡:</label>
                        <input type="number" id="red-y" step="0.0001" min="0" max="1" value="0.3">
                    </div>
                    <div class="input-row">
                        <label>æœ€å¤§å…‰é€šé‡:</label>
                        <input type="number" id="red-max" step="0.1" min="0" value="100">
                    </div>
                </div>
                
                <div class="color-input green">
                    <h4>ğŸŸ¢ ç»¿è‰² (G)</h4>
                    <div class="input-row">
                        <label>xåæ ‡:</label>
                        <input type="number" id="green-x" step="0.0001" min="0" max="1" value="0.2">
                    </div>
                    <div class="input-row">
                        <label>yåæ ‡:</label>
                        <input type="number" id="green-y" step="0.0001" min="0" max="1" value="0.7">
                    </div>
                    <div class="input-row">
                        <label>æœ€å¤§å…‰é€šé‡:</label>
                        <input type="number" id="green-max" step="0.1" min="0" value="100">
                    </div>
                </div>
                
                <div class="color-input blue">
                    <h4>ğŸ”µ è“è‰² (B)</h4>
                    <div class="input-row">
                        <label>xåæ ‡:</label>
                        <input type="number" id="blue-x" step="0.0001" min="0" max="1" value="0.1">
                    </div>
                    <div class="input-row">
                        <label>yåæ ‡:</label>
                        <input type="number" id="blue-y" step="0.0001" min="0" max="1" value="0.1">
                    </div>
                    <div class="input-row">
                        <label>æœ€å¤§å…‰é€šé‡:</label>
                        <input type="number" id="blue-max" step="0.1" min="0" value="100">
                    </div>
                </div>
                
                <div class="color-input target">
                    <h4>ğŸ¯ ç›®æ ‡è‰²</h4>
                    <div class="input-row">
                        <label>xåæ ‡:</label>
                        <input type="number" id="target-x" step="0.0001" min="0" max="1" value="0.3333">
                    </div>
                    <div class="input-row">
                        <label>yåæ ‡:</label>
                        <input type="number" id="target-y" step="0.0001" min="0" max="1" value="0.3333">
                    </div>
                    <div class="small-text">
                        æç¤ºï¼š(0.3333, 0.3333) æ˜¯ç™½è‰²
                    </div>
                </div>
            </div>
        </div>
        
        <button class="calculate-btn" onclick="startCalculation()">å¼€å§‹è®¡ç®—</button>
        
        <div id="error-message" class="error-box"></div>
        
        <!-- æ­¥éª¤2ï¼šåŸºæœ¬æ¦‚å¿µè§£é‡Š -->
        <div id="step2" class="step-section">
            <h2>ç¬¬äºŒæ­¥ï¼šç†è§£åŸºæœ¬æ¦‚å¿µ</h2>
            
            <h3>ä»€ä¹ˆæ˜¯è‰²åæ ‡ï¼Ÿ</h3>
            <div class="explanation">
                åœ¨CIE 1931è‰²åº¦ç³»ç»Ÿä¸­ï¼Œä»»ä½•é¢œè‰²éƒ½å¯ä»¥ç”¨ä¸‰ä¸ªåæ ‡(x, y, z)æ¥è¡¨ç¤ºã€‚
                ç”±äºx + y + z = 1ï¼ˆå½’ä¸€åŒ–æ¡ä»¶ï¼‰ï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“xå’Œyå°±èƒ½ç¡®å®šä¸€ä¸ªé¢œè‰²ã€‚
            </div>
            
            <h3>è®¡ç®—zåæ ‡</h3>
            <div class="formula">
                z = 1 - x - y
            </div>
            
            <div id="z-calculations" class="result-box"></div>
            
            <h3>ä»€ä¹ˆæ˜¯å…‰é€šé‡ï¼Ÿ</h3>
            <div class="explanation">
                å…‰é€šé‡ï¼ˆLuminous fluxï¼‰è¡¨ç¤ºå…‰æºå‘å‡ºçš„æ€»å…‰é‡ï¼Œå•ä½é€šå¸¸æ˜¯æµæ˜(lm)ã€‚
                åœ¨æˆ‘ä»¬çš„è®¡ç®—ä¸­ï¼Œå®ƒè¡¨ç¤ºæ¯ä¸ªåŸºè‰²çš„äº®åº¦ã€‚
            </div>
        </div>
        
        <!-- æ­¥éª¤3ï¼šè½¬æ¢åˆ°XYZè‰²å½©ç©ºé—´ -->
        <div id="step3" class="step-section">
            <h2>ç¬¬ä¸‰æ­¥ï¼šè½¬æ¢åˆ°XYZè‰²å½©ç©ºé—´</h2>
            
            <h3>ä¸ºä»€ä¹ˆè¦è½¬æ¢åˆ°XYZç©ºé—´ï¼Ÿ</h3>
            <div class="explanation">
                <strong>é‡è¦åŸç†ï¼š</strong>é¢œè‰²çš„çº¿æ€§å åŠ æ€§è´¨<span class="warning">åªåœ¨XYZä¸‰åˆºæ¿€å€¼ç©ºé—´ä¸­æˆç«‹</span>ï¼Œ
                ç›´æ¥å¯¹è‰²åæ ‡(x,y)è¿›è¡ŒåŠ æƒå¹³å‡æ˜¯é”™è¯¯çš„ï¼
                <br><br>
                å½“ä¸¤ä¸ªæˆ–å¤šä¸ªå…‰æºæ··åˆæ—¶ï¼Œå®ƒä»¬çš„ä¸‰åˆºæ¿€å€¼(X,Y,Z)å¯ä»¥ç›´æ¥ç›¸åŠ ï¼Œè€Œè‰²åæ ‡éœ€è¦é‡æ–°è®¡ç®—ã€‚
            </div>
            
            <h3>è½¬æ¢å…¬å¼</h3>
            <div class="explanation">
                å°†è‰²åæ ‡(x, y)å’Œå…‰é€šé‡Yè½¬æ¢ä¸ºä¸‰åˆºæ¿€å€¼(X, Y, Z)ï¼š
            </div>
            
            <div class="formula">
                <div>X = (x / y) Ã— Y</div>
                <div>Y = Y ï¼ˆå…‰é€šé‡æœ¬èº«å°±æ˜¯Yåˆºæ¿€å€¼ï¼‰</div>
                <div>Z = ((1 - x - y) / y) Ã— Y</div>
            </div>
            
            <h3>å„åŸºè‰²çš„XYZå€¼è®¡ç®—</h3>
            <div id="xyz-calculations" class="result-box"></div>
            
            <h3>æ··åˆåŸç†</h3>
            <div class="explanation">
                è®¾çº¢ã€ç»¿ã€è“çš„ä½¿ç”¨ç³»æ•°ä¸ºc<sub>R</sub>ã€c<sub>G</sub>ã€c<sub>B</sub>ï¼ˆèŒƒå›´0-1ï¼‰ï¼Œ
                åˆ™æ··åˆåçš„ä¸‰åˆºæ¿€å€¼ä¸ºï¼š
            </div>
            
            <div class="formula">
                <div>X<sub>mix</sub> = c<sub>R</sub> Ã— X<sub>R,max</sub> + c<sub>G</sub> Ã— X<sub>G,max</sub> + c<sub>B</sub> Ã— X<sub>B,max</sub></div>
                <div>Y<sub>mix</sub> = c<sub>R</sub> Ã— Y<sub>R,max</sub> + c<sub>G</sub> Ã— Y<sub>G,max</sub> + c<sub>B</sub> Ã— Y<sub>B,max</sub></div>
                <div>Z<sub>mix</sub> = c<sub>R</sub> Ã— Z<sub>R,max</sub> + c<sub>G</sub> Ã— Z<sub>G,max</sub> + c<sub>B</sub> Ã— Z<sub>B,max</sub></div>
            </div>
        </div>
        
        <!-- æ­¥éª¤4ï¼šå»ºç«‹çº¦æŸæ¡ä»¶ -->
        <div id="step4" class="step-section">
            <h2>ç¬¬å››æ­¥ï¼šå»ºç«‹çº¦æŸæ¡ä»¶</h2>
            
            <h3>ç›®æ ‡è‰²çº¦æŸ</h3>
            <div class="explanation">
                æ··åˆåçš„é¢œè‰²å¿…é¡»ç¬¦åˆç›®æ ‡è‰²çš„è‰²åæ ‡ã€‚æ ¹æ®è‰²åæ ‡çš„å®šä¹‰ï¼š
            </div>
            
            <div class="formula">
                <div>x<sub>ç›®æ ‡</sub> = X<sub>mix</sub> / (X<sub>mix</sub> + Y<sub>mix</sub> + Z<sub>mix</sub>)</div>
                <div>y<sub>ç›®æ ‡</sub> = Y<sub>mix</sub> / (X<sub>mix</sub> + Y<sub>mix</sub> + Z<sub>mix</sub>)</div>
            </div>
            
            <div class="explanation">
                ä¸ºäº†æ¶ˆé™¤åˆ†æ¯ï¼Œæˆ‘ä»¬å°†ä¸Šè¿°æ–¹ç¨‹è½¬æ¢ä¸ºçº¿æ€§çº¦æŸï¼š
            </div>
            
            <div class="formula">
                <div>çº¦æŸ1ï¼šy<sub>ç›®æ ‡</sub> Ã— X<sub>mix</sub> - x<sub>ç›®æ ‡</sub> Ã— Y<sub>mix</sub> = 0</div>
                <div>çº¦æŸ2ï¼šy<sub>ç›®æ ‡</sub> Ã— Z<sub>mix</sub> - z<sub>ç›®æ ‡</sub> Ã— Y<sub>mix</sub> = 0</div>
                <div>å…¶ä¸­ï¼šz<sub>ç›®æ ‡</sub> = 1 - x<sub>ç›®æ ‡</sub> - y<sub>ç›®æ ‡</sub></div>
            </div>
            
            <div id="constraint-equations" class="formula"></div>
            
            <h3>çº¿æ€§è§„åˆ’é—®é¢˜</h3>
            <div class="explanation">
                ç°åœ¨æˆ‘ä»¬æœ‰äº†ä¸€ä¸ª<strong>çº¿æ€§è§„åˆ’é—®é¢˜</strong>ï¼š
                <br>
                <strong>ç›®æ ‡ï¼š</strong>æœ€å¤§åŒ– Y<sub>mix</sub>ï¼ˆæ€»å…‰é€šé‡ï¼‰
                <br>
                <strong>çº¦æŸï¼š</strong>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    <li>ä¸¤ä¸ªç›®æ ‡è‰²åæ ‡çº¦æŸæ–¹ç¨‹</li>
                    <li>0 â‰¤ c<sub>R</sub> â‰¤ 1, 0 â‰¤ c<sub>G</sub> â‰¤ 1, 0 â‰¤ c<sub>B</sub> â‰¤ 1</li>
                </ul>
            </div>
        </div>
        
        <!-- æ­¥éª¤5ï¼šçº¿æ€§è§„åˆ’æ±‚è§£ -->
        <div id="step5" class="step-section">
            <h2>ç¬¬äº”æ­¥ï¼šçº¿æ€§è§„åˆ’æ±‚è§£</h2>
            
            <h3>å…³é”®æ´å¯Ÿ</h3>
            <div class="explanation">
                ç”±äºæˆ‘ä»¬æœ‰2ä¸ªçº¦æŸæ–¹ç¨‹å’Œ3ä¸ªæœªçŸ¥æ•°ï¼Œè¿™æ˜¯ä¸€ä¸ª<strong>æ¬ å®šæ–¹ç¨‹ç»„</strong>ã€‚
                æœ€ä¼˜è§£å¿…ç„¶å‡ºç°åœ¨å¯è¡ŒåŸŸçš„<strong>è¾¹ç•Œ</strong>ä¸Šï¼Œå³è‡³å°‘æœ‰ä¸€ä¸ªåŸºè‰²è¾¾åˆ°æ»¡è½½çŠ¶æ€ï¼ˆc = 1ï¼‰ã€‚
            </div>
            
            <h3>æ±‚è§£ç­–ç•¥</h3>
            <div class="explanation">
                æˆ‘ä»¬åˆ†åˆ«å‡è®¾æ¯ä¸ªåŸºè‰²æ»¡è½½ï¼Œæ±‚è§£å…¶ä»–ä¸¤ä¸ªç³»æ•°ï¼Œç„¶åæ¯”è¾ƒå“ªç§æƒ…å†µèƒ½å¾—åˆ°æœ€å¤§å…‰é€šé‡ï¼š
            </div>
            
            <div class="formula">
                <div><strong>æƒ…å†µ1ï¼š</strong>å‡è®¾çº¢è‰²æ»¡è½½ (c<sub>R</sub> = 1)</div>
                <div><strong>æƒ…å†µ2ï¼š</strong>å‡è®¾ç»¿è‰²æ»¡è½½ (c<sub>G</sub> = 1)</div>
                <div><strong>æƒ…å†µ3ï¼š</strong>å‡è®¾è“è‰²æ»¡è½½ (c<sub>B</sub> = 1)</div>
            </div>
            
            <div id="optimization-process" class="result-box"></div>
            
            <h3>æ±‚è§£è¿‡ç¨‹</h3>
            <div class="explanation">
                å¯¹äºæ¯ç§æƒ…å†µï¼Œæˆ‘ä»¬å°†çº¦æŸæ–¹ç¨‹ç»„ç®€åŒ–ä¸º2Ã—2çš„çº¿æ€§æ–¹ç¨‹ç»„ï¼Œç„¶åæ±‚è§£ï¼š
            </div>
            
            <div id="solution-steps" class="formula"></div>
            
            <h3>æœ‰æ•ˆæ€§æ£€éªŒ</h3>
            <div class="explanation">
                æ¯ä¸ªè§£éƒ½å¿…é¡»æ»¡è¶³ï¼š<strong>0 â‰¤ c<sub>i</sub> â‰¤ 1</strong>
                <br>
                å¦‚æœæŸä¸ªç³»æ•°è¶…å‡ºèŒƒå›´ï¼Œè¯´æ˜è¯¥è§£ä¸å¯è¡Œã€‚
            </div>
        </div>
        
        <!-- æ­¥éª¤6ï¼šæœ€ç»ˆç»“æœ -->
        <div id="step6" class="step-section">
            <h2>ç¬¬å…­æ­¥ï¼šè®¡ç®—æœ€ç»ˆç»“æœ</h2>
            
            <h3>æœ€å¤§æ€»å…‰é€šé‡</h3>
            <div id="max-luminance" class="result-box"></div>
            
            <h3>å„åŸºè‰²çš„å®é™…ä½¿ç”¨é‡</h3>
            <table id="usage-table">
                <thead>
                    <tr>
                        <th>åŸºè‰²</th>
                        <th>æ‰€éœ€æ¯”ä¾‹</th>
                        <th>å®é™…ä½¿ç”¨é‡</th>
                        <th>æœ€å¤§é™åˆ¶</th>
                        <th>ä½¿ç”¨ç‡</th>
                    </tr>
                </thead>
                <tbody id="usage-tbody">
                </tbody>
            </table>
            
            <h3>ç»“è®º</h3>
            <div id="conclusion" class="explanation"></div>
        </div>
    </div>
    
    <!-- å¼•å…¥XYZè®¡ç®—æ¨¡å— -->
    <script src="js/xyz-calculator.js"></script>
    
    <script>
        function startCalculation() {
            // æ¸…é™¤ä¹‹å‰çš„è®¡ç®—ç»“æœ
            document.querySelectorAll('.step-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById('error-message').style.display = 'none';
            
            // è¯»å–è¾“å…¥æ•°æ®
            const data = {
                red: {
                    x: parseFloat(document.getElementById('red-x').value),
                    y: parseFloat(document.getElementById('red-y').value),
                    max: parseFloat(document.getElementById('red-max').value)
                },
                green: {
                    x: parseFloat(document.getElementById('green-x').value),
                    y: parseFloat(document.getElementById('green-y').value),
                    max: parseFloat(document.getElementById('green-max').value)
                },
                blue: {
                    x: parseFloat(document.getElementById('blue-x').value),
                    y: parseFloat(document.getElementById('blue-y').value),
                    max: parseFloat(document.getElementById('blue-max').value)
                },
                target: {
                    x: parseFloat(document.getElementById('target-x').value),
                    y: parseFloat(document.getElementById('target-y').value)
                }
            };
            
            // éªŒè¯è¾“å…¥
            if (!validateInput(data)) {
                return;
            }
            
            // å¼€å§‹é€æ­¥è®¡ç®—
            setTimeout(() => step2_calculateZ(data), 100);
        }
        
        function validateInput(data) {
            // æ£€æŸ¥æ˜¯å¦æœ‰ç©ºå€¼
            for (let color in data) {
                for (let prop in data[color]) {
                    if (isNaN(data[color][prop])) {
                        showError('è¯·å¡«å†™æ‰€æœ‰è¾“å…¥é¡¹ï¼');
                        return false;
                    }
                }
            }
            
            // æ£€æŸ¥åæ ‡èŒƒå›´
            for (let color in data) {
                if (data[color].x < 0 || data[color].x > 1 || data[color].y < 0 || data[color].y > 1) {
                    showError('è‰²åæ ‡å¿…é¡»åœ¨0åˆ°1ä¹‹é—´ï¼');
                    return false;
                }
            }
            
            // æ£€æŸ¥yåæ ‡ä¸ä¸º0
            for (let color in data) {
                if (data[color].y <= 0) {
                    showError('yåæ ‡ä¸èƒ½ä¸º0æˆ–è´Ÿæ•°ï¼');
                    return false;
                }
            }
            
            // æ£€æŸ¥æœ€å¤§å…‰é€šé‡
            if (data.red.max <= 0 || data.green.max <= 0 || data.blue.max <= 0) {
                showError('æœ€å¤§å…‰é€šé‡å¿…é¡»å¤§äº0ï¼');
                return false;
            }
            
            return true;
        }
        
        function showError(message) {
            const errorBox = document.getElementById('error-message');
            errorBox.textContent = message;
            errorBox.style.display = 'block';
        }
        
        function step2_calculateZ(data) {
            document.getElementById('step2').classList.add('active');
            
            // è®¡ç®—zåæ ‡
            data.red.z = 1 - data.red.x - data.red.y;
            data.green.z = 1 - data.green.x - data.green.y;
            data.blue.z = 1 - data.blue.x - data.blue.y;
            data.target.z = 1 - data.target.x - data.target.y;
            
            // æ˜¾ç¤ºè®¡ç®—ç»“æœ
            const zCalc = document.getElementById('z-calculations');
            zCalc.innerHTML = `
                <div>çº¢è‰²ï¼šz<sub>r</sub> = 1 - ${data.red.x.toFixed(4)} - ${data.red.y.toFixed(4)} = <span class="highlight">${data.red.z.toFixed(4)}</span></div>
                <div>ç»¿è‰²ï¼šz<sub>g</sub> = 1 - ${data.green.x.toFixed(4)} - ${data.green.y.toFixed(4)} = <span class="highlight">${data.green.z.toFixed(4)}</span></div>
                <div>è“è‰²ï¼šz<sub>b</sub> = 1 - ${data.blue.x.toFixed(4)} - ${data.blue.y.toFixed(4)} = <span class="highlight">${data.blue.z.toFixed(4)}</span></div>
                <div>ç›®æ ‡è‰²ï¼šz<sub>t</sub> = 1 - ${data.target.x.toFixed(4)} - ${data.target.y.toFixed(4)} = <span class="highlight">${data.target.z.toFixed(4)}</span></div>
            `;
            
            setTimeout(() => step3_convertToXYZ(data), 1000);
        }
        
        function step3_convertToXYZ(data) {
            document.getElementById('step3').classList.add('active');
            
            try {
                // ä½¿ç”¨XYZè®¡ç®—æ¨¡å—è½¬æ¢å„åŸºè‰²
                data.redXYZ = XYZCalculator.xyToXYZ(data.red.x, data.red.y, data.red.max);
                data.greenXYZ = XYZCalculator.xyToXYZ(data.green.x, data.green.y, data.green.max);
                data.blueXYZ = XYZCalculator.xyToXYZ(data.blue.x, data.blue.y, data.blue.max);
                
                // æ˜¾ç¤ºXYZè®¡ç®—ç»“æœ
                const xyzCalc = document.getElementById('xyz-calculations');
                xyzCalc.innerHTML = `
                    <div><strong>çº¢è‰²åŸºè‰²æœ€å¤§XYZå€¼ï¼š</strong></div>
                    <div>X<sub>R</sub> = (${data.red.x.toFixed(4)} / ${data.red.y.toFixed(4)}) Ã— ${data.red.max} = <span class="highlight">${data.redXYZ.X.toFixed(3)}</span></div>
                    <div>Y<sub>R</sub> = ${data.red.max} = <span class="highlight">${data.redXYZ.Y.toFixed(3)}</span></div>
                    <div>Z<sub>R</sub> = ((1 - ${data.red.x.toFixed(4)} - ${data.red.y.toFixed(4)}) / ${data.red.y.toFixed(4)}) Ã— ${data.red.max} = <span class="highlight">${data.redXYZ.Z.toFixed(3)}</span></div>
                    <br>
                    <div><strong>ç»¿è‰²åŸºè‰²æœ€å¤§XYZå€¼ï¼š</strong></div>
                    <div>X<sub>G</sub> = (${data.green.x.toFixed(4)} / ${data.green.y.toFixed(4)}) Ã— ${data.green.max} = <span class="highlight">${data.greenXYZ.X.toFixed(3)}</span></div>
                    <div>Y<sub>G</sub> = ${data.green.max} = <span class="highlight">${data.greenXYZ.Y.toFixed(3)}</span></div>
                    <div>Z<sub>G</sub> = ((1 - ${data.green.x.toFixed(4)} - ${data.green.y.toFixed(4)}) / ${data.green.y.toFixed(4)}) Ã— ${data.green.max} = <span class="highlight">${data.greenXYZ.Z.toFixed(3)}</span></div>
                    <br>
                    <div><strong>è“è‰²åŸºè‰²æœ€å¤§XYZå€¼ï¼š</strong></div>
                    <div>X<sub>B</sub> = (${data.blue.x.toFixed(4)} / ${data.blue.y.toFixed(4)}) Ã— ${data.blue.max} = <span class="highlight">${data.blueXYZ.X.toFixed(3)}</span></div>
                    <div>Y<sub>B</sub> = ${data.blue.max} = <span class="highlight">${data.blueXYZ.Y.toFixed(3)}</span></div>
                    <div>Z<sub>B</sub> = ((1 - ${data.blue.x.toFixed(4)} - ${data.blue.y.toFixed(4)}) / ${data.blue.y.toFixed(4)}) Ã— ${data.blue.max} = <span class="highlight">${data.blueXYZ.Z.toFixed(3)}</span></div>
                `;
                
                setTimeout(() => step4_buildConstraints(data), 1500);
                
            } catch (error) {
                showError('XYZè½¬æ¢å¤±è´¥ï¼š' + error.message);
            }
        }
        
        function step4_buildConstraints(data) {
            document.getElementById('step4').classList.add('active');
            
            // è®¡ç®—ç›®æ ‡è‰²çš„zåæ ‡
            const zt = 1 - data.target.x - data.target.y;
            
            // æ˜¾ç¤ºçº¦æŸæ–¹ç¨‹
            const constraintEq = document.getElementById('constraint-equations');
            constraintEq.innerHTML = `
                <div><strong>å…·ä½“çº¦æŸæ–¹ç¨‹ï¼š</strong></div>
                <div>çº¦æŸ1ï¼š${data.target.y.toFixed(4)} Ã— X<sub>mix</sub> - ${data.target.x.toFixed(4)} Ã— Y<sub>mix</sub> = 0</div>
                <div>çº¦æŸ2ï¼š${data.target.y.toFixed(4)} Ã— Z<sub>mix</sub> - ${zt.toFixed(4)} Ã— Y<sub>mix</sub> = 0</div>
                <br>
                <div>å±•å¼€åï¼š</div>
                <div>çº¦æŸ1ï¼š${data.target.y.toFixed(4)} Ã— (c<sub>R</sub>Ã—${data.redXYZ.X.toFixed(3)} + c<sub>G</sub>Ã—${data.greenXYZ.X.toFixed(3)} + c<sub>B</sub>Ã—${data.blueXYZ.X.toFixed(3)}) - ${data.target.x.toFixed(4)} Ã— (c<sub>R</sub>Ã—${data.redXYZ.Y.toFixed(3)} + c<sub>G</sub>Ã—${data.greenXYZ.Y.toFixed(3)} + c<sub>B</sub>Ã—${data.blueXYZ.Y.toFixed(3)}) = 0</div>
                <div>çº¦æŸ2ï¼š${data.target.y.toFixed(4)} Ã— (c<sub>R</sub>Ã—${data.redXYZ.Z.toFixed(3)} + c<sub>G</sub>Ã—${data.greenXYZ.Z.toFixed(3)} + c<sub>B</sub>Ã—${data.blueXYZ.Z.toFixed(3)}) - ${zt.toFixed(4)} Ã— (c<sub>R</sub>Ã—${data.redXYZ.Y.toFixed(3)} + c<sub>G</sub>Ã—${data.greenXYZ.Y.toFixed(3)} + c<sub>B</sub>Ã—${data.blueXYZ.Y.toFixed(3)}) = 0</div>
            `;
            
            setTimeout(() => step5_linearProgramming(data), 1500);
        }
        
        function step5_linearProgramming(data) {
            document.getElementById('step5').classList.add('active');
            
            try {
                // ä½¿ç”¨XYZè®¡ç®—æ¨¡å—è¿›è¡Œçº¿æ€§è§„åˆ’æ±‚è§£
                const result = XYZCalculator.calculateMaxLuminanceXYZ(
                    { x: data.red.x, y: data.red.y, maxY: data.red.max },
                    { x: data.green.x, y: data.green.y, maxY: data.green.max },
                    { x: data.blue.x, y: data.blue.y, maxY: data.blue.max },
                    { x: data.target.x, y: data.target.y }
                );
                
                if (result.error) {
                    showError(result.error);
                    return;
                }
                
                // æ˜¾ç¤ºä¼˜åŒ–è¿‡ç¨‹
                const processDiv = document.getElementById('optimization-process');
                processDiv.innerHTML = `
                    <div><strong>çº¿æ€§è§„åˆ’ç»“æœï¼š</strong></div>
                    <div>æœ€å¤§å…‰é€šé‡ï¼š<span class="highlight">${result.maxLuminance.toFixed(3)}</span></div>
                    <div>é™åˆ¶å› å­ï¼š<span class="warning">${result.limitingColor === 'red' ? 'çº¢è‰²' : result.limitingColor === 'green' ? 'ç»¿è‰²' : 'è“è‰²'}</span></div>
                    <div>æœ€ä¼˜ç³»æ•°ï¼šc<sub>R</sub> = ${result.coefficients.red.toFixed(4)}, c<sub>G</sub> = ${result.coefficients.green.toFixed(4)}, c<sub>B</sub> = ${result.coefficients.blue.toFixed(4)}</div>
                `;
                
                // æ˜¾ç¤ºæ±‚è§£æ­¥éª¤
                const stepsDiv = document.getElementById('solution-steps');
                stepsDiv.innerHTML = `
                    <div><strong>è¯¦ç»†æ±‚è§£è¿‡ç¨‹ï¼š</strong></div>
                    <div>1. å‡è®¾${result.limitingColor === 'red' ? 'çº¢è‰²' : result.limitingColor === 'green' ? 'ç»¿è‰²' : 'è“è‰²'}æ»¡è½½ (c = 1)</div>
                    <div>2. å°†çº¦æŸæ–¹ç¨‹ç®€åŒ–ä¸º2Ã—2çº¿æ€§æ–¹ç¨‹ç»„</div>
                    <div>3. æ±‚è§£å…¶ä»–ä¸¤ä¸ªç³»æ•°</div>
                    <div>4. éªŒè¯æ‰€æœ‰ç³»æ•°éƒ½åœ¨[0,1]èŒƒå›´å†…</div>
                    <div>5. è®¡ç®—æ€»å…‰é€šé‡ï¼šY<sub>mix</sub> = ${result.maxLuminance.toFixed(3)}</div>
                `;
                
                // ä¿å­˜ç»“æœä¾›ä¸‹ä¸€æ­¥ä½¿ç”¨
                data.xyzResult = result;
                
                setTimeout(() => step6_showResults(data), 1500);
                
            } catch (error) {
                showError('çº¿æ€§è§„åˆ’æ±‚è§£å¤±è´¥ï¼š' + error.message);
            }
        }
        
        function step6_showResults(data) {
            document.getElementById('step6').classList.add('active');
            
            const result = data.xyzResult;
            const maxLuminance = result.maxLuminance;
            
            // è®¡ç®—å®é™…ä½¿ç”¨é‡
            const usage = {
                red: result.coefficients.red * data.red.max,
                green: result.coefficients.green * data.green.max,
                blue: result.coefficients.blue * data.blue.max
            };
            
            // æ˜¾ç¤ºæœ€å¤§å…‰é€šé‡
            document.getElementById('max-luminance').innerHTML = `
                ç›®æ ‡è‰²èƒ½è¾¾åˆ°çš„æœ€å¤§æ€»å…‰é€šé‡ï¼š<span class="highlight" style="font-size: 24px;">${maxLuminance.toFixed(3)}</span>
            `;
            
            // å¡«å……ä½¿ç”¨é‡è¡¨æ ¼
            const tbody = document.getElementById('usage-tbody');
            const limitingColorCN = result.limitingColor === 'red' ? 'çº¢è‰²' : result.limitingColor === 'green' ? 'ç»¿è‰²' : 'è“è‰²';
            
            tbody.innerHTML = `
                <tr${result.limitingColor === 'red' ? ' style="background-color: #ffebee;"' : ''}>
                    <td style="color: #e74c3c; font-weight: bold;">çº¢è‰²</td>
                    <td>${result.coefficients.red.toFixed(4)}</td>
                    <td>${usage.red.toFixed(3)}</td>
                    <td>${data.red.max}</td>
                    <td>${(result.coefficients.red * 100).toFixed(1)}%</td>
                </tr>
                <tr${result.limitingColor === 'green' ? ' style="background-color: #e8f5e8;"' : ''}>
                    <td style="color: #27ae60; font-weight: bold;">ç»¿è‰²</td>
                    <td>${result.coefficients.green.toFixed(4)}</td>
                    <td>${usage.green.toFixed(3)}</td>
                    <td>${data.green.max}</td>
                    <td>${(result.coefficients.green * 100).toFixed(1)}%</td>
                </tr>
                <tr${result.limitingColor === 'blue' ? ' style="background-color: #e3f2fd;"' : ''}>
                    <td style="color: #3498db; font-weight: bold;">è“è‰²</td>
                    <td>${result.coefficients.blue.toFixed(4)}</td>
                    <td>${usage.blue.toFixed(3)}</td>
                    <td>${data.blue.max}</td>
                    <td>${(result.coefficients.blue * 100).toFixed(1)}%</td>
                </tr>
            `;
            
            // æ˜¾ç¤ºç»“è®º
            document.getElementById('conclusion').innerHTML = `
                <div class="success">
                    ä½¿ç”¨æ­£ç¡®çš„XYZç©ºé—´ç®—æ³•ï¼Œç›®æ ‡è‰²(${data.target.x.toFixed(4)}, ${data.target.y.toFixed(4)})
                    èƒ½å¤Ÿè¾¾åˆ°çš„æœ€å¤§å…‰é€šé‡ä¸º <strong>${maxLuminance.toFixed(3)}</strong>ã€‚
                </div>
                <div style="margin-top: 15px;">
                    <strong>å…³é”®ç»“æœï¼š</strong>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>${limitingColorCN}è¾¾åˆ°æ»¡è½½çŠ¶æ€ï¼ˆä½¿ç”¨ç³»æ•° = 1.0ï¼‰ï¼Œæˆä¸ºé™åˆ¶å› ç´ </li>
                        <li>è¿™æ˜¯åŸºäº<span class="warning">æ­£ç¡®çš„ä¸‰åˆºæ¿€å€¼å åŠ åŸç†</span>å¾—å‡ºçš„ç»“æœ</li>
                        <li>å¦‚éœ€æ›´é«˜å…‰é€šé‡ï¼Œåº”æå‡${limitingColorCN}çš„æœ€å¤§å…‰é€šé‡é™åˆ¶</li>
                    </ul>
                </div>
                <div style="margin-top: 15px; padding: 10px; background-color: #fff3cd; border-radius: 5px;">
                    <strong>âš ï¸ é‡è¦æé†’ï¼š</strong>æœ¬è®¡ç®—ä½¿ç”¨äº†æ­£ç¡®çš„XYZè‰²å½©ç©ºé—´æ··åˆç†è®ºï¼Œ
                    ä¸ç›´æ¥å¯¹è‰²åæ ‡åŠ æƒå¹³å‡çš„é”™è¯¯æ–¹æ³•ç›¸æ¯”ï¼Œç»“æœæ›´åŠ å‡†ç¡®å¯é ã€‚
                </div>
            `;
        }
        
        // æ±‚è§£çº¿æ€§æ–¹ç¨‹ç»„çš„å‡½æ•°
        function solveLinearSystem(A, b) {
            const n = A.length;
            
            // åˆ›å»ºå¢å¹¿çŸ©é˜µ
            const augmented = [];
            for (let i = 0; i < n; i++) {
                augmented.push([...A[i], b[i]]);
            }
            
            // é«˜æ–¯æ¶ˆå…ƒ
            for (let i = 0; i < n; i++) {
                // æ‰¾ä¸»å…ƒ
                let maxRow = i;
                for (let k = i + 1; k < n; k++) {
                    if (Math.abs(augmented[k][i]) > Math.abs(augmented[maxRow][i])) {
                        maxRow = k;
                    }
                }
                
                // äº¤æ¢è¡Œ
                [augmented[i], augmented[maxRow]] = [augmented[maxRow], augmented[i]];
                
                // æ£€æŸ¥ä¸»å…ƒæ˜¯å¦ä¸º0
                if (Math.abs(augmented[i][i]) < 1e-10) {
                    throw new Error('çŸ©é˜µå¥‡å¼‚ï¼Œæ— æ³•æ±‚è§£');
                }
                
                // æ¶ˆå…ƒ
                for (let k = i + 1; k < n; k++) {
                    const factor = augmented[k][i] / augmented[i][i];
                    for (let j = i; j <= n; j++) {
                        augmented[k][j] -= factor * augmented[i][j];
                    }
                }
            }
            
            // å›ä»£
            const x = new Array(n);
            for (let i = n - 1; i >= 0; i--) {
                x[i] = augmented[i][n];
                for (let j = i + 1; j < n; j++) {
                    x[i] -= augmented[i][j] * x[j];
                }
                x[i] /= augmented[i][i];
            }
            
            return x;
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>最大光通量计算过程演示</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Microsoft YaHei", Arial, sans-serif;
            line-height: 1.8;
            color: #333;
            background-color: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        
        h2 {
            color: #34495e;
            margin-top: 30px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }
        
        h3 {
            color: #7f8c8d;
            margin-top: 20px;
            margin-bottom: 15px;
        }
        
        .input-section {
            background-color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .input-group {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .color-input {
            flex: 1;
            min-width: 250px;
            padding: 15px;
            background-color: white;
            border-radius: 5px;
            border: 2px solid transparent;
        }
        
        .color-input.red {
            border-color: #e74c3c;
        }
        
        .color-input.green {
            border-color: #27ae60;
        }
        
        .color-input.blue {
            border-color: #3498db;
        }
        
        .color-input.target {
            border-color: #9b59b6;
        }
        
        .color-input h4 {
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .input-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 10px;
        }
        
        label {
            display: inline-block;
            width: 100px;
            font-weight: bold;
        }
        
        input[type="number"] {
            width: 120px;
            padding: 5px 10px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 16px;
        }
        
        input[type="number"]:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .calculate-btn {
            display: block;
            width: 300px;
            margin: 30px auto;
            padding: 15px;
            background-color: #3498db;
            color: white;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .calculate-btn:hover {
            background-color: #2980b9;
        }
        
        .step-section {
            margin-bottom: 40px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            display: none;
        }
        
        .step-section.active {
            display: block;
        }
        
        .explanation {
            background-color: #e8f5ff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 16px;
            line-height: 1.8;
        }
        
        .formula {
            background-color: #fff;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 15px 0;
            font-family: "Courier New", monospace;
            font-size: 14px;
            overflow-x: auto;
        }
        
        .matrix {
            display: inline-block;
            vertical-align: middle;
            margin: 0 10px;
        }
        
        .matrix-bracket {
            display: inline-block;
            vertical-align: middle;
            font-size: 40px;
            font-weight: 100;
        }
        
        .matrix-content {
            display: inline-block;
            vertical-align: middle;
        }
        
        .matrix-row {
            display: block;
            text-align: center;
            margin: 5px 0;
        }
        
        .matrix-cell {
            display: inline-block;
            width: 80px;
            text-align: center;
            padding: 0 5px;
        }
        
        .result-box {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            font-weight: bold;
        }
        
        .error-box {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            color: #721c24;
            display: none;
        }
        
        .highlight {
            background-color: #fff3cd;
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: bold;
        }
        
        .small-text {
            font-size: 14px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        th, td {
            padding: 10px;
            text-align: center;
            border: 1px solid #ddd;
        }
        
        th {
            background-color: #3498db;
            color: white;
            font-weight: bold;
        }
        
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        .warning {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .success {
            color: #27ae60;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>最大光通量计算过程详细演示</h1>
        
        <div class="input-section">
            <h2>第一步：输入数据</h2>
            <div class="explanation">
                请输入RGB三基色的色坐标(x, y)和最大光通量限制，以及目标色的色坐标。
                色坐标范围为0到1之间，光通量为正数。
            </div>
            
            <div class="input-group">
                <div class="color-input red">
                    <h4>🔴 红色 (R)</h4>
                    <div class="input-row">
                        <label>x坐标:</label>
                        <input type="number" id="red-x" step="0.0001" min="0" max="1" value="0.7">
                    </div>
                    <div class="input-row">
                        <label>y坐标:</label>
                        <input type="number" id="red-y" step="0.0001" min="0" max="1" value="0.3">
                    </div>
                    <div class="input-row">
                        <label>最大光通量:</label>
                        <input type="number" id="red-max" step="0.1" min="0" value="100">
                    </div>
                </div>
                
                <div class="color-input green">
                    <h4>🟢 绿色 (G)</h4>
                    <div class="input-row">
                        <label>x坐标:</label>
                        <input type="number" id="green-x" step="0.0001" min="0" max="1" value="0.2">
                    </div>
                    <div class="input-row">
                        <label>y坐标:</label>
                        <input type="number" id="green-y" step="0.0001" min="0" max="1" value="0.7">
                    </div>
                    <div class="input-row">
                        <label>最大光通量:</label>
                        <input type="number" id="green-max" step="0.1" min="0" value="100">
                    </div>
                </div>
                
                <div class="color-input blue">
                    <h4>🔵 蓝色 (B)</h4>
                    <div class="input-row">
                        <label>x坐标:</label>
                        <input type="number" id="blue-x" step="0.0001" min="0" max="1" value="0.1">
                    </div>
                    <div class="input-row">
                        <label>y坐标:</label>
                        <input type="number" id="blue-y" step="0.0001" min="0" max="1" value="0.1">
                    </div>
                    <div class="input-row">
                        <label>最大光通量:</label>
                        <input type="number" id="blue-max" step="0.1" min="0" value="100">
                    </div>
                </div>
                
                <div class="color-input target">
                    <h4>🎯 目标色</h4>
                    <div class="input-row">
                        <label>x坐标:</label>
                        <input type="number" id="target-x" step="0.0001" min="0" max="1" value="0.3333">
                    </div>
                    <div class="input-row">
                        <label>y坐标:</label>
                        <input type="number" id="target-y" step="0.0001" min="0" max="1" value="0.3333">
                    </div>
                    <div class="small-text">
                        提示：(0.3333, 0.3333) 是白色
                    </div>
                </div>
            </div>
        </div>
        
        <button class="calculate-btn" onclick="startCalculation()">开始计算</button>
        
        <div id="error-message" class="error-box"></div>
        
        <!-- 步骤2：基本概念解释 -->
        <div id="step2" class="step-section">
            <h2>第二步：理解基本概念</h2>
            
            <h3>什么是色坐标？</h3>
            <div class="explanation">
                在CIE 1931色度系统中，任何颜色都可以用三个坐标(x, y, z)来表示。
                由于x + y + z = 1（归一化条件），我们只需要知道x和y就能确定一个颜色。
            </div>
            
            <h3>计算z坐标</h3>
            <div class="formula">
                z = 1 - x - y
            </div>
            
            <div id="z-calculations" class="result-box"></div>
            
            <h3>什么是光通量？</h3>
            <div class="explanation">
                光通量（Luminous flux）表示光源发出的总光量，单位通常是流明(lm)。
                在我们的计算中，它表示每个基色的亮度。
            </div>
        </div>
        
        <!-- 步骤3：转换到XYZ色彩空间 -->
        <div id="step3" class="step-section">
            <h2>第三步：转换到XYZ色彩空间</h2>
            
            <h3>为什么要转换到XYZ空间？</h3>
            <div class="explanation">
                <strong>重要原理：</strong>颜色的线性叠加性质<span class="warning">只在XYZ三刺激值空间中成立</span>，
                直接对色坐标(x,y)进行加权平均是错误的！
                <br><br>
                当两个或多个光源混合时，它们的三刺激值(X,Y,Z)可以直接相加，而色坐标需要重新计算。
            </div>
            
            <h3>转换公式</h3>
            <div class="explanation">
                将色坐标(x, y)和光通量Y转换为三刺激值(X, Y, Z)：
            </div>
            
            <div class="formula">
                <div>X = (x / y) × Y</div>
                <div>Y = Y （光通量本身就是Y刺激值）</div>
                <div>Z = ((1 - x - y) / y) × Y</div>
            </div>
            
            <h3>各基色的XYZ值计算</h3>
            <div id="xyz-calculations" class="result-box"></div>
            
            <h3>混合原理</h3>
            <div class="explanation">
                设红、绿、蓝的使用系数为c<sub>R</sub>、c<sub>G</sub>、c<sub>B</sub>（范围0-1），
                则混合后的三刺激值为：
            </div>
            
            <div class="formula">
                <div>X<sub>mix</sub> = c<sub>R</sub> × X<sub>R,max</sub> + c<sub>G</sub> × X<sub>G,max</sub> + c<sub>B</sub> × X<sub>B,max</sub></div>
                <div>Y<sub>mix</sub> = c<sub>R</sub> × Y<sub>R,max</sub> + c<sub>G</sub> × Y<sub>G,max</sub> + c<sub>B</sub> × Y<sub>B,max</sub></div>
                <div>Z<sub>mix</sub> = c<sub>R</sub> × Z<sub>R,max</sub> + c<sub>G</sub> × Z<sub>G,max</sub> + c<sub>B</sub> × Z<sub>B,max</sub></div>
            </div>
        </div>
        
        <!-- 步骤4：建立约束条件 -->
        <div id="step4" class="step-section">
            <h2>第四步：建立约束条件</h2>
            
            <h3>目标色约束</h3>
            <div class="explanation">
                混合后的颜色必须符合目标色的色坐标。根据色坐标的定义：
            </div>
            
            <div class="formula">
                <div>x<sub>目标</sub> = X<sub>mix</sub> / (X<sub>mix</sub> + Y<sub>mix</sub> + Z<sub>mix</sub>)</div>
                <div>y<sub>目标</sub> = Y<sub>mix</sub> / (X<sub>mix</sub> + Y<sub>mix</sub> + Z<sub>mix</sub>)</div>
            </div>
            
            <div class="explanation">
                为了消除分母，我们将上述方程转换为线性约束：
            </div>
            
            <div class="formula">
                <div>约束1：y<sub>目标</sub> × X<sub>mix</sub> - x<sub>目标</sub> × Y<sub>mix</sub> = 0</div>
                <div>约束2：y<sub>目标</sub> × Z<sub>mix</sub> - z<sub>目标</sub> × Y<sub>mix</sub> = 0</div>
                <div>其中：z<sub>目标</sub> = 1 - x<sub>目标</sub> - y<sub>目标</sub></div>
            </div>
            
            <div id="constraint-equations" class="formula"></div>
            
            <h3>线性规划问题</h3>
            <div class="explanation">
                现在我们有了一个<strong>线性规划问题</strong>：
                <br>
                <strong>目标：</strong>最大化 Y<sub>mix</sub>（总光通量）
                <br>
                <strong>约束：</strong>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    <li>两个目标色坐标约束方程</li>
                    <li>0 ≤ c<sub>R</sub> ≤ 1, 0 ≤ c<sub>G</sub> ≤ 1, 0 ≤ c<sub>B</sub> ≤ 1</li>
                </ul>
            </div>
        </div>
        
        <!-- 步骤5：线性规划求解 -->
        <div id="step5" class="step-section">
            <h2>第五步：线性规划求解</h2>
            
            <h3>关键洞察</h3>
            <div class="explanation">
                由于我们有2个约束方程和3个未知数，这是一个<strong>欠定方程组</strong>。
                最优解必然出现在可行域的<strong>边界</strong>上，即至少有一个基色达到满载状态（c = 1）。
            </div>
            
            <h3>求解策略</h3>
            <div class="explanation">
                我们分别假设每个基色满载，求解其他两个系数，然后比较哪种情况能得到最大光通量：
            </div>
            
            <div class="formula">
                <div><strong>情况1：</strong>假设红色满载 (c<sub>R</sub> = 1)</div>
                <div><strong>情况2：</strong>假设绿色满载 (c<sub>G</sub> = 1)</div>
                <div><strong>情况3：</strong>假设蓝色满载 (c<sub>B</sub> = 1)</div>
            </div>
            
            <div id="optimization-process" class="result-box"></div>
            
            <h3>求解过程</h3>
            <div class="explanation">
                对于每种情况，我们将约束方程组简化为2×2的线性方程组，然后求解：
            </div>
            
            <div id="solution-steps" class="formula"></div>
            
            <h3>有效性检验</h3>
            <div class="explanation">
                每个解都必须满足：<strong>0 ≤ c<sub>i</sub> ≤ 1</strong>
                <br>
                如果某个系数超出范围，说明该解不可行。
            </div>
        </div>
        
        <!-- 步骤6：最终结果 -->
        <div id="step6" class="step-section">
            <h2>第六步：计算最终结果</h2>
            
            <h3>最大总光通量</h3>
            <div id="max-luminance" class="result-box"></div>
            
            <h3>各基色的实际使用量</h3>
            <table id="usage-table">
                <thead>
                    <tr>
                        <th>基色</th>
                        <th>所需比例</th>
                        <th>实际使用量</th>
                        <th>最大限制</th>
                        <th>使用率</th>
                    </tr>
                </thead>
                <tbody id="usage-tbody">
                </tbody>
            </table>
            
            <h3>结论</h3>
            <div id="conclusion" class="explanation"></div>
        </div>
    </div>
    
    <!-- 引入XYZ计算模块 -->
    <script src="js/xyz-calculator.js"></script>
    
    <script>
        function startCalculation() {
            // 清除之前的计算结果
            document.querySelectorAll('.step-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById('error-message').style.display = 'none';
            
            // 读取输入数据
            const data = {
                red: {
                    x: parseFloat(document.getElementById('red-x').value),
                    y: parseFloat(document.getElementById('red-y').value),
                    max: parseFloat(document.getElementById('red-max').value)
                },
                green: {
                    x: parseFloat(document.getElementById('green-x').value),
                    y: parseFloat(document.getElementById('green-y').value),
                    max: parseFloat(document.getElementById('green-max').value)
                },
                blue: {
                    x: parseFloat(document.getElementById('blue-x').value),
                    y: parseFloat(document.getElementById('blue-y').value),
                    max: parseFloat(document.getElementById('blue-max').value)
                },
                target: {
                    x: parseFloat(document.getElementById('target-x').value),
                    y: parseFloat(document.getElementById('target-y').value)
                }
            };
            
            // 验证输入
            if (!validateInput(data)) {
                return;
            }
            
            // 开始逐步计算
            setTimeout(() => step2_calculateZ(data), 100);
        }
        
        function validateInput(data) {
            // 检查是否有空值
            for (let color in data) {
                for (let prop in data[color]) {
                    if (isNaN(data[color][prop])) {
                        showError('请填写所有输入项！');
                        return false;
                    }
                }
            }
            
            // 检查坐标范围
            for (let color in data) {
                if (data[color].x < 0 || data[color].x > 1 || data[color].y < 0 || data[color].y > 1) {
                    showError('色坐标必须在0到1之间！');
                    return false;
                }
            }
            
            // 检查y坐标不为0
            for (let color in data) {
                if (data[color].y <= 0) {
                    showError('y坐标不能为0或负数！');
                    return false;
                }
            }
            
            // 检查最大光通量
            if (data.red.max <= 0 || data.green.max <= 0 || data.blue.max <= 0) {
                showError('最大光通量必须大于0！');
                return false;
            }
            
            return true;
        }
        
        function showError(message) {
            const errorBox = document.getElementById('error-message');
            errorBox.textContent = message;
            errorBox.style.display = 'block';
        }
        
        function step2_calculateZ(data) {
            document.getElementById('step2').classList.add('active');
            
            // 计算z坐标
            data.red.z = 1 - data.red.x - data.red.y;
            data.green.z = 1 - data.green.x - data.green.y;
            data.blue.z = 1 - data.blue.x - data.blue.y;
            data.target.z = 1 - data.target.x - data.target.y;
            
            // 显示计算结果
            const zCalc = document.getElementById('z-calculations');
            zCalc.innerHTML = `
                <div>红色：z<sub>r</sub> = 1 - ${data.red.x.toFixed(4)} - ${data.red.y.toFixed(4)} = <span class="highlight">${data.red.z.toFixed(4)}</span></div>
                <div>绿色：z<sub>g</sub> = 1 - ${data.green.x.toFixed(4)} - ${data.green.y.toFixed(4)} = <span class="highlight">${data.green.z.toFixed(4)}</span></div>
                <div>蓝色：z<sub>b</sub> = 1 - ${data.blue.x.toFixed(4)} - ${data.blue.y.toFixed(4)} = <span class="highlight">${data.blue.z.toFixed(4)}</span></div>
                <div>目标色：z<sub>t</sub> = 1 - ${data.target.x.toFixed(4)} - ${data.target.y.toFixed(4)} = <span class="highlight">${data.target.z.toFixed(4)}</span></div>
            `;
            
            setTimeout(() => step3_convertToXYZ(data), 1000);
        }
        
        function step3_convertToXYZ(data) {
            document.getElementById('step3').classList.add('active');
            
            try {
                // 使用XYZ计算模块转换各基色
                data.redXYZ = XYZCalculator.xyToXYZ(data.red.x, data.red.y, data.red.max);
                data.greenXYZ = XYZCalculator.xyToXYZ(data.green.x, data.green.y, data.green.max);
                data.blueXYZ = XYZCalculator.xyToXYZ(data.blue.x, data.blue.y, data.blue.max);
                
                // 显示XYZ计算结果
                const xyzCalc = document.getElementById('xyz-calculations');
                xyzCalc.innerHTML = `
                    <div><strong>红色基色最大XYZ值：</strong></div>
                    <div>X<sub>R</sub> = (${data.red.x.toFixed(4)} / ${data.red.y.toFixed(4)}) × ${data.red.max} = <span class="highlight">${data.redXYZ.X.toFixed(3)}</span></div>
                    <div>Y<sub>R</sub> = ${data.red.max} = <span class="highlight">${data.redXYZ.Y.toFixed(3)}</span></div>
                    <div>Z<sub>R</sub> = ((1 - ${data.red.x.toFixed(4)} - ${data.red.y.toFixed(4)}) / ${data.red.y.toFixed(4)}) × ${data.red.max} = <span class="highlight">${data.redXYZ.Z.toFixed(3)}</span></div>
                    <br>
                    <div><strong>绿色基色最大XYZ值：</strong></div>
                    <div>X<sub>G</sub> = (${data.green.x.toFixed(4)} / ${data.green.y.toFixed(4)}) × ${data.green.max} = <span class="highlight">${data.greenXYZ.X.toFixed(3)}</span></div>
                    <div>Y<sub>G</sub> = ${data.green.max} = <span class="highlight">${data.greenXYZ.Y.toFixed(3)}</span></div>
                    <div>Z<sub>G</sub> = ((1 - ${data.green.x.toFixed(4)} - ${data.green.y.toFixed(4)}) / ${data.green.y.toFixed(4)}) × ${data.green.max} = <span class="highlight">${data.greenXYZ.Z.toFixed(3)}</span></div>
                    <br>
                    <div><strong>蓝色基色最大XYZ值：</strong></div>
                    <div>X<sub>B</sub> = (${data.blue.x.toFixed(4)} / ${data.blue.y.toFixed(4)}) × ${data.blue.max} = <span class="highlight">${data.blueXYZ.X.toFixed(3)}</span></div>
                    <div>Y<sub>B</sub> = ${data.blue.max} = <span class="highlight">${data.blueXYZ.Y.toFixed(3)}</span></div>
                    <div>Z<sub>B</sub> = ((1 - ${data.blue.x.toFixed(4)} - ${data.blue.y.toFixed(4)}) / ${data.blue.y.toFixed(4)}) × ${data.blue.max} = <span class="highlight">${data.blueXYZ.Z.toFixed(3)}</span></div>
                `;
                
                setTimeout(() => step4_buildConstraints(data), 1500);
                
            } catch (error) {
                showError('XYZ转换失败：' + error.message);
            }
        }
        
        function step4_buildConstraints(data) {
            document.getElementById('step4').classList.add('active');
            
            // 计算目标色的z坐标
            const zt = 1 - data.target.x - data.target.y;
            
            // 显示约束方程
            const constraintEq = document.getElementById('constraint-equations');
            constraintEq.innerHTML = `
                <div><strong>具体约束方程：</strong></div>
                <div>约束1：${data.target.y.toFixed(4)} × X<sub>mix</sub> - ${data.target.x.toFixed(4)} × Y<sub>mix</sub> = 0</div>
                <div>约束2：${data.target.y.toFixed(4)} × Z<sub>mix</sub> - ${zt.toFixed(4)} × Y<sub>mix</sub> = 0</div>
                <br>
                <div>展开后：</div>
                <div>约束1：${data.target.y.toFixed(4)} × (c<sub>R</sub>×${data.redXYZ.X.toFixed(3)} + c<sub>G</sub>×${data.greenXYZ.X.toFixed(3)} + c<sub>B</sub>×${data.blueXYZ.X.toFixed(3)}) - ${data.target.x.toFixed(4)} × (c<sub>R</sub>×${data.redXYZ.Y.toFixed(3)} + c<sub>G</sub>×${data.greenXYZ.Y.toFixed(3)} + c<sub>B</sub>×${data.blueXYZ.Y.toFixed(3)}) = 0</div>
                <div>约束2：${data.target.y.toFixed(4)} × (c<sub>R</sub>×${data.redXYZ.Z.toFixed(3)} + c<sub>G</sub>×${data.greenXYZ.Z.toFixed(3)} + c<sub>B</sub>×${data.blueXYZ.Z.toFixed(3)}) - ${zt.toFixed(4)} × (c<sub>R</sub>×${data.redXYZ.Y.toFixed(3)} + c<sub>G</sub>×${data.greenXYZ.Y.toFixed(3)} + c<sub>B</sub>×${data.blueXYZ.Y.toFixed(3)}) = 0</div>
            `;
            
            setTimeout(() => step5_linearProgramming(data), 1500);
        }
        
        function step5_linearProgramming(data) {
            document.getElementById('step5').classList.add('active');
            
            try {
                // 使用XYZ计算模块进行线性规划求解
                const result = XYZCalculator.calculateMaxLuminanceXYZ(
                    { x: data.red.x, y: data.red.y, maxY: data.red.max },
                    { x: data.green.x, y: data.green.y, maxY: data.green.max },
                    { x: data.blue.x, y: data.blue.y, maxY: data.blue.max },
                    { x: data.target.x, y: data.target.y }
                );
                
                if (result.error) {
                    showError(result.error);
                    return;
                }
                
                // 显示优化过程
                const processDiv = document.getElementById('optimization-process');
                processDiv.innerHTML = `
                    <div><strong>线性规划结果：</strong></div>
                    <div>最大光通量：<span class="highlight">${result.maxLuminance.toFixed(3)}</span></div>
                    <div>限制因子：<span class="warning">${result.limitingColor === 'red' ? '红色' : result.limitingColor === 'green' ? '绿色' : '蓝色'}</span></div>
                    <div>最优系数：c<sub>R</sub> = ${result.coefficients.red.toFixed(4)}, c<sub>G</sub> = ${result.coefficients.green.toFixed(4)}, c<sub>B</sub> = ${result.coefficients.blue.toFixed(4)}</div>
                `;
                
                // 显示求解步骤
                const stepsDiv = document.getElementById('solution-steps');
                stepsDiv.innerHTML = `
                    <div><strong>详细求解过程：</strong></div>
                    <div>1. 假设${result.limitingColor === 'red' ? '红色' : result.limitingColor === 'green' ? '绿色' : '蓝色'}满载 (c = 1)</div>
                    <div>2. 将约束方程简化为2×2线性方程组</div>
                    <div>3. 求解其他两个系数</div>
                    <div>4. 验证所有系数都在[0,1]范围内</div>
                    <div>5. 计算总光通量：Y<sub>mix</sub> = ${result.maxLuminance.toFixed(3)}</div>
                `;
                
                // 保存结果供下一步使用
                data.xyzResult = result;
                
                setTimeout(() => step6_showResults(data), 1500);
                
            } catch (error) {
                showError('线性规划求解失败：' + error.message);
            }
        }
        
        function step6_showResults(data) {
            document.getElementById('step6').classList.add('active');
            
            const result = data.xyzResult;
            const maxLuminance = result.maxLuminance;
            
            // 计算实际使用量
            const usage = {
                red: result.coefficients.red * data.red.max,
                green: result.coefficients.green * data.green.max,
                blue: result.coefficients.blue * data.blue.max
            };
            
            // 显示最大光通量
            document.getElementById('max-luminance').innerHTML = `
                目标色能达到的最大总光通量：<span class="highlight" style="font-size: 24px;">${maxLuminance.toFixed(3)}</span>
            `;
            
            // 填充使用量表格
            const tbody = document.getElementById('usage-tbody');
            const limitingColorCN = result.limitingColor === 'red' ? '红色' : result.limitingColor === 'green' ? '绿色' : '蓝色';
            
            tbody.innerHTML = `
                <tr${result.limitingColor === 'red' ? ' style="background-color: #ffebee;"' : ''}>
                    <td style="color: #e74c3c; font-weight: bold;">红色</td>
                    <td>${result.coefficients.red.toFixed(4)}</td>
                    <td>${usage.red.toFixed(3)}</td>
                    <td>${data.red.max}</td>
                    <td>${(result.coefficients.red * 100).toFixed(1)}%</td>
                </tr>
                <tr${result.limitingColor === 'green' ? ' style="background-color: #e8f5e8;"' : ''}>
                    <td style="color: #27ae60; font-weight: bold;">绿色</td>
                    <td>${result.coefficients.green.toFixed(4)}</td>
                    <td>${usage.green.toFixed(3)}</td>
                    <td>${data.green.max}</td>
                    <td>${(result.coefficients.green * 100).toFixed(1)}%</td>
                </tr>
                <tr${result.limitingColor === 'blue' ? ' style="background-color: #e3f2fd;"' : ''}>
                    <td style="color: #3498db; font-weight: bold;">蓝色</td>
                    <td>${result.coefficients.blue.toFixed(4)}</td>
                    <td>${usage.blue.toFixed(3)}</td>
                    <td>${data.blue.max}</td>
                    <td>${(result.coefficients.blue * 100).toFixed(1)}%</td>
                </tr>
            `;
            
            // 显示结论
            document.getElementById('conclusion').innerHTML = `
                <div class="success">
                    使用正确的XYZ空间算法，目标色(${data.target.x.toFixed(4)}, ${data.target.y.toFixed(4)})
                    能够达到的最大光通量为 <strong>${maxLuminance.toFixed(3)}</strong>。
                </div>
                <div style="margin-top: 15px;">
                    <strong>关键结果：</strong>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>${limitingColorCN}达到满载状态（使用系数 = 1.0），成为限制因素</li>
                        <li>这是基于<span class="warning">正确的三刺激值叠加原理</span>得出的结果</li>
                        <li>如需更高光通量，应提升${limitingColorCN}的最大光通量限制</li>
                    </ul>
                </div>
                <div style="margin-top: 15px; padding: 10px; background-color: #fff3cd; border-radius: 5px;">
                    <strong>⚠️ 重要提醒：</strong>本计算使用了正确的XYZ色彩空间混合理论，
                    与直接对色坐标加权平均的错误方法相比，结果更加准确可靠。
                </div>
            `;
        }
        
        // 求解线性方程组的函数
        function solveLinearSystem(A, b) {
            const n = A.length;
            
            // 创建增广矩阵
            const augmented = [];
            for (let i = 0; i < n; i++) {
                augmented.push([...A[i], b[i]]);
            }
            
            // 高斯消元
            for (let i = 0; i < n; i++) {
                // 找主元
                let maxRow = i;
                for (let k = i + 1; k < n; k++) {
                    if (Math.abs(augmented[k][i]) > Math.abs(augmented[maxRow][i])) {
                        maxRow = k;
                    }
                }
                
                // 交换行
                [augmented[i], augmented[maxRow]] = [augmented[maxRow], augmented[i]];
                
                // 检查主元是否为0
                if (Math.abs(augmented[i][i]) < 1e-10) {
                    throw new Error('矩阵奇异，无法求解');
                }
                
                // 消元
                for (let k = i + 1; k < n; k++) {
                    const factor = augmented[k][i] / augmented[i][i];
                    for (let j = i; j <= n; j++) {
                        augmented[k][j] -= factor * augmented[i][j];
                    }
                }
            }
            
            // 回代
            const x = new Array(n);
            for (let i = n - 1; i >= 0; i--) {
                x[i] = augmented[i][n];
                for (let j = i + 1; j < n; j++) {
                    x[i] -= augmented[i][j] * x[j];
                }
                x[i] /= augmented[i][i];
            }
            
            return x;
        }
    </script>
</body>
</html>
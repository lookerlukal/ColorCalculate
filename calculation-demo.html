<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ€å¤§å…‰é€šé‡è®¡ç®—è¿‡ç¨‹æ¼”ç¤º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Microsoft YaHei", Arial, sans-serif;
            line-height: 1.8;
            color: #333;
            background-color: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        
        h2 {
            color: #34495e;
            margin-top: 30px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }
        
        h3 {
            color: #7f8c8d;
            margin-top: 20px;
            margin-bottom: 15px;
        }
        
        .input-section {
            background-color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .input-group {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .color-input {
            flex: 1;
            min-width: 250px;
            padding: 15px;
            background-color: white;
            border-radius: 5px;
            border: 2px solid transparent;
        }
        
        .color-input.red {
            border-color: #e74c3c;
        }
        
        .color-input.green {
            border-color: #27ae60;
        }
        
        .color-input.blue {
            border-color: #3498db;
        }
        
        .color-input.target {
            border-color: #9b59b6;
        }
        
        .color-input h4 {
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .input-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 10px;
        }
        
        label {
            display: inline-block;
            width: 100px;
            font-weight: bold;
        }
        
        input[type="number"] {
            width: 120px;
            padding: 5px 10px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 16px;
        }
        
        input[type="number"]:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .calculate-btn {
            display: block;
            width: 300px;
            margin: 30px auto;
            padding: 15px;
            background-color: #3498db;
            color: white;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .calculate-btn:hover {
            background-color: #2980b9;
        }
        
        .step-section {
            margin-bottom: 40px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            display: none;
        }
        
        .step-section.active {
            display: block;
        }
        
        .explanation {
            background-color: #e8f5ff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 16px;
            line-height: 1.8;
        }
        
        .formula {
            background-color: #fff;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 15px 0;
            font-family: "Courier New", monospace;
            font-size: 14px;
            overflow-x: auto;
        }
        
        .matrix {
            display: inline-block;
            vertical-align: middle;
            margin: 0 10px;
        }
        
        .matrix-bracket {
            display: inline-block;
            vertical-align: middle;
            font-size: 40px;
            font-weight: 100;
        }
        
        .matrix-content {
            display: inline-block;
            vertical-align: middle;
        }
        
        .matrix-row {
            display: block;
            text-align: center;
            margin: 5px 0;
        }
        
        .matrix-cell {
            display: inline-block;
            width: 80px;
            text-align: center;
            padding: 0 5px;
        }
        
        .result-box {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            font-weight: bold;
        }
        
        .error-box {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            color: #721c24;
            display: none;
        }
        
        .highlight {
            background-color: #fff3cd;
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: bold;
        }
        
        .small-text {
            font-size: 14px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        th, td {
            padding: 10px;
            text-align: center;
            border: 1px solid #ddd;
        }
        
        th {
            background-color: #3498db;
            color: white;
            font-weight: bold;
        }
        
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        .warning {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .success {
            color: #27ae60;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>æœ€å¤§å…‰é€šé‡è®¡ç®—è¿‡ç¨‹è¯¦ç»†æ¼”ç¤º</h1>
        
        <div class="input-section">
            <h2>ç¬¬ä¸€æ­¥ï¼šè¾“å…¥æ•°æ®</h2>
            <div class="explanation">
                è¯·è¾“å…¥RGBä¸‰åŸºè‰²çš„è‰²åæ ‡(x, y)å’Œæœ€å¤§å…‰é€šé‡é™åˆ¶ï¼Œä»¥åŠç›®æ ‡è‰²çš„è‰²åæ ‡ã€‚
                è‰²åæ ‡èŒƒå›´ä¸º0åˆ°1ä¹‹é—´ï¼Œå…‰é€šé‡ä¸ºæ­£æ•°ã€‚
            </div>
            
            <div class="input-group">
                <div class="color-input red">
                    <h4>ğŸ”´ çº¢è‰² (R)</h4>
                    <div class="input-row">
                        <label>xåæ ‡:</label>
                        <input type="number" id="red-x" step="0.0001" min="0" max="1" value="0.7">
                    </div>
                    <div class="input-row">
                        <label>yåæ ‡:</label>
                        <input type="number" id="red-y" step="0.0001" min="0" max="1" value="0.3">
                    </div>
                    <div class="input-row">
                        <label>æœ€å¤§å…‰é€šé‡:</label>
                        <input type="number" id="red-max" step="0.1" min="0" value="100">
                    </div>
                </div>
                
                <div class="color-input green">
                    <h4>ğŸŸ¢ ç»¿è‰² (G)</h4>
                    <div class="input-row">
                        <label>xåæ ‡:</label>
                        <input type="number" id="green-x" step="0.0001" min="0" max="1" value="0.2">
                    </div>
                    <div class="input-row">
                        <label>yåæ ‡:</label>
                        <input type="number" id="green-y" step="0.0001" min="0" max="1" value="0.7">
                    </div>
                    <div class="input-row">
                        <label>æœ€å¤§å…‰é€šé‡:</label>
                        <input type="number" id="green-max" step="0.1" min="0" value="100">
                    </div>
                </div>
                
                <div class="color-input blue">
                    <h4>ğŸ”µ è“è‰² (B)</h4>
                    <div class="input-row">
                        <label>xåæ ‡:</label>
                        <input type="number" id="blue-x" step="0.0001" min="0" max="1" value="0.1">
                    </div>
                    <div class="input-row">
                        <label>yåæ ‡:</label>
                        <input type="number" id="blue-y" step="0.0001" min="0" max="1" value="0.1">
                    </div>
                    <div class="input-row">
                        <label>æœ€å¤§å…‰é€šé‡:</label>
                        <input type="number" id="blue-max" step="0.1" min="0" value="100">
                    </div>
                </div>
                
                <div class="color-input target">
                    <h4>ğŸ¯ ç›®æ ‡è‰²</h4>
                    <div class="input-row">
                        <label>xåæ ‡:</label>
                        <input type="number" id="target-x" step="0.0001" min="0" max="1" value="0.3333">
                    </div>
                    <div class="input-row">
                        <label>yåæ ‡:</label>
                        <input type="number" id="target-y" step="0.0001" min="0" max="1" value="0.3333">
                    </div>
                    <div class="small-text">
                        æç¤ºï¼š(0.3333, 0.3333) æ˜¯ç™½è‰²
                    </div>
                </div>
            </div>
        </div>
        
        <button class="calculate-btn" onclick="startCalculation()">å¼€å§‹è®¡ç®—</button>
        
        <div id="error-message" class="error-box"></div>
        
        <!-- æ­¥éª¤2ï¼šåŸºæœ¬æ¦‚å¿µè§£é‡Š -->
        <div id="step2" class="step-section">
            <h2>ç¬¬äºŒæ­¥ï¼šç†è§£åŸºæœ¬æ¦‚å¿µ</h2>
            
            <h3>ä»€ä¹ˆæ˜¯è‰²åæ ‡ï¼Ÿ</h3>
            <div class="explanation">
                åœ¨CIE 1931è‰²åº¦ç³»ç»Ÿä¸­ï¼Œä»»ä½•é¢œè‰²éƒ½å¯ä»¥ç”¨ä¸‰ä¸ªåæ ‡(x, y, z)æ¥è¡¨ç¤ºã€‚
                ç”±äºx + y + z = 1ï¼ˆå½’ä¸€åŒ–æ¡ä»¶ï¼‰ï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“xå’Œyå°±èƒ½ç¡®å®šä¸€ä¸ªé¢œè‰²ã€‚
            </div>
            
            <h3>è®¡ç®—zåæ ‡</h3>
            <div class="formula">
                z = 1 - x - y
            </div>
            
            <div id="z-calculations" class="result-box"></div>
            
            <h3>ä»€ä¹ˆæ˜¯å…‰é€šé‡ï¼Ÿ</h3>
            <div class="explanation">
                å…‰é€šé‡ï¼ˆLuminous fluxï¼‰è¡¨ç¤ºå…‰æºå‘å‡ºçš„æ€»å…‰é‡ï¼Œå•ä½é€šå¸¸æ˜¯æµæ˜(lm)ã€‚
                åœ¨æˆ‘ä»¬çš„è®¡ç®—ä¸­ï¼Œå®ƒè¡¨ç¤ºæ¯ä¸ªåŸºè‰²çš„äº®åº¦ã€‚
            </div>
        </div>
        
        <!-- æ­¥éª¤3ï¼šå»ºç«‹æ–¹ç¨‹ç»„ -->
        <div id="step3" class="step-section">
            <h2>ç¬¬ä¸‰æ­¥ï¼šå»ºç«‹çº¿æ€§æ–¹ç¨‹ç»„</h2>
            
            <h3>é¢œè‰²æ··åˆåŸç†</h3>
            <div class="explanation">
                å½“RGBä¸‰ç§å…‰æ··åˆæ—¶ï¼Œåˆæˆè‰²çš„åæ ‡æ˜¯å„åŸºè‰²åæ ‡çš„åŠ æƒå¹³å‡ï¼Œæƒé‡å°±æ˜¯å„åŸºè‰²çš„å…‰é€šé‡ã€‚
                æˆ‘ä»¬éœ€è¦æ‰¾åˆ°åˆé€‚çš„RGBå…‰é€šé‡æ¯”ä¾‹ï¼Œä½¿å¾—æ··åˆåå¾—åˆ°ç›®æ ‡è‰²ã€‚
            </div>
            
            <h3>æ–¹ç¨‹ç»„æ¨å¯¼</h3>
            <div class="explanation">
                è®¾çº¢è‰²å…‰é€šé‡ä¸ºL<sub>r</sub>ï¼Œç»¿è‰²ä¸ºL<sub>g</sub>ï¼Œè“è‰²ä¸ºL<sub>b</sub>ï¼Œæ€»å…‰é€šé‡ä¸ºL<sub>t</sub>ï¼Œåˆ™æœ‰ï¼š
            </div>
            
            <div class="formula">
                <div>ç¬¬ä¸€ä¸ªæ–¹ç¨‹ï¼ˆxåæ ‡å¹³è¡¡ï¼‰ï¼š</div>
                <div>(x<sub>r</sub>/y<sub>r</sub>)Â·L<sub>r</sub> + (x<sub>g</sub>/y<sub>g</sub>)Â·L<sub>g</sub> + (x<sub>b</sub>/y<sub>b</sub>)Â·L<sub>b</sub> = (x<sub>t</sub>/y<sub>t</sub>)Â·L<sub>t</sub></div>
                <br>
                <div>ç¬¬äºŒä¸ªæ–¹ç¨‹ï¼ˆå…‰é€šé‡å®ˆæ’ï¼‰ï¼š</div>
                <div>L<sub>r</sub> + L<sub>g</sub> + L<sub>b</sub> = L<sub>t</sub></div>
                <br>
                <div>ç¬¬ä¸‰ä¸ªæ–¹ç¨‹ï¼ˆzåæ ‡å¹³è¡¡ï¼‰ï¼š</div>
                <div>(z<sub>r</sub>/y<sub>r</sub>)Â·L<sub>r</sub> + (z<sub>g</sub>/y<sub>g</sub>)Â·L<sub>g</sub> + (z<sub>b</sub>/y<sub>b</sub>)Â·L<sub>b</sub> = (z<sub>t</sub>/y<sub>t</sub>)Â·L<sub>t</sub></div>
            </div>
            
            <h3>æ ‡å‡†åŒ–å¤„ç†</h3>
            <div class="explanation">
                ä¸ºäº†ç®€åŒ–è®¡ç®—ï¼Œæˆ‘ä»¬å…ˆå‡è®¾æ€»å…‰é€šé‡L<sub>t</sub> = 1ï¼Œæ±‚å‡ºå„åŸºè‰²çš„æ¯”ä¾‹ã€‚
                è¿™æ ·æ–¹ç¨‹ç»„å˜ä¸ºï¼š
            </div>
            
            <div id="matrix-equation" class="formula"></div>
        </div>
        
        <!-- æ­¥éª¤4ï¼šæ±‚è§£æ–¹ç¨‹ç»„ -->
        <div id="step4" class="step-section">
            <h2>ç¬¬å››æ­¥ï¼šæ±‚è§£çº¿æ€§æ–¹ç¨‹ç»„</h2>
            
            <h3>ä½¿ç”¨é«˜æ–¯æ¶ˆå…ƒæ³•</h3>
            <div class="explanation">
                æˆ‘ä»¬ä½¿ç”¨é«˜æ–¯æ¶ˆå…ƒæ³•æ¥æ±‚è§£è¿™ä¸ª3Ã—3çš„çº¿æ€§æ–¹ç¨‹ç»„ã€‚è¿™ä¸ªæ–¹æ³•é€šè¿‡è¡Œå˜æ¢å°†ç³»æ•°çŸ©é˜µåŒ–ä¸ºä¸Šä¸‰è§’å½¢å¼ï¼Œ
                ç„¶åé€šè¿‡å›ä»£æ±‚è§£ã€‚
            </div>
            
            <div id="gaussian-steps" class="formula"></div>
            
            <h3>æ±‚è§£ç»“æœ</h3>
            <div id="solution-result" class="result-box"></div>
        </div>
        
        <!-- æ­¥éª¤5ï¼šè®¡ç®—ç¼©æ”¾å› å­ -->
        <div id="step5" class="step-section">
            <h2>ç¬¬äº”æ­¥ï¼šè®¡ç®—æœ€å¤§å¯èƒ½çš„å…‰é€šé‡</h2>
            
            <h3>ç†è§£é™åˆ¶æ¡ä»¶</h3>
            <div class="explanation">
                æˆ‘ä»¬å·²ç»çŸ¥é“äº†è¾¾åˆ°ç›®æ ‡è‰²æ‰€éœ€çš„RGBæ¯”ä¾‹ï¼Œä½†æ¯ä¸ªåŸºè‰²éƒ½æœ‰æœ€å¤§å…‰é€šé‡é™åˆ¶ã€‚
                ç°åœ¨è¦æ‰¾å‡ºåœ¨ä¸è¶…è¿‡ä»»ä½•é™åˆ¶çš„æƒ…å†µä¸‹ï¼Œèƒ½è¾¾åˆ°çš„æœ€å¤§æ€»å…‰é€šé‡ã€‚
            </div>
            
            <h3>è®¡ç®—ç¼©æ”¾å› å­</h3>
            <div class="explanation">
                å¯¹äºæ¯ä¸ªåŸºè‰²ï¼Œè®¡ç®—å…¶æœ€å¤§å…‰é€šé‡ä¸æ‰€éœ€æ¯”ä¾‹çš„æ¯”å€¼ï¼š
            </div>
            
            <div id="scale-factors" class="formula"></div>
            
            <h3>ç¡®å®šé™åˆ¶å› å­</h3>
            <div class="explanation">
                æœ€å°çš„ç¼©æ”¾å› å­å†³å®šäº†æœ€å¤§å¯èƒ½çš„æ€»å…‰é€šé‡ã€‚è¿™æ˜¯å› ä¸ºä¸€æ—¦æŸä¸ªåŸºè‰²è¾¾åˆ°å…¶æœ€å¤§å€¼ï¼Œ
                å°±ä¸èƒ½å†å¢åŠ æ€»å…‰é€šé‡äº†ã€‚
            </div>
            
            <div id="limiting-factor" class="result-box"></div>
        </div>
        
        <!-- æ­¥éª¤6ï¼šæœ€ç»ˆç»“æœ -->
        <div id="step6" class="step-section">
            <h2>ç¬¬å…­æ­¥ï¼šè®¡ç®—æœ€ç»ˆç»“æœ</h2>
            
            <h3>æœ€å¤§æ€»å…‰é€šé‡</h3>
            <div id="max-luminance" class="result-box"></div>
            
            <h3>å„åŸºè‰²çš„å®é™…ä½¿ç”¨é‡</h3>
            <table id="usage-table">
                <thead>
                    <tr>
                        <th>åŸºè‰²</th>
                        <th>æ‰€éœ€æ¯”ä¾‹</th>
                        <th>å®é™…ä½¿ç”¨é‡</th>
                        <th>æœ€å¤§é™åˆ¶</th>
                        <th>ä½¿ç”¨ç‡</th>
                    </tr>
                </thead>
                <tbody id="usage-tbody">
                </tbody>
            </table>
            
            <h3>ç»“è®º</h3>
            <div id="conclusion" class="explanation"></div>
        </div>
    </div>
    
    <script>
        function startCalculation() {
            // æ¸…é™¤ä¹‹å‰çš„è®¡ç®—ç»“æœ
            document.querySelectorAll('.step-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById('error-message').style.display = 'none';
            
            // è¯»å–è¾“å…¥æ•°æ®
            const data = {
                red: {
                    x: parseFloat(document.getElementById('red-x').value),
                    y: parseFloat(document.getElementById('red-y').value),
                    max: parseFloat(document.getElementById('red-max').value)
                },
                green: {
                    x: parseFloat(document.getElementById('green-x').value),
                    y: parseFloat(document.getElementById('green-y').value),
                    max: parseFloat(document.getElementById('green-max').value)
                },
                blue: {
                    x: parseFloat(document.getElementById('blue-x').value),
                    y: parseFloat(document.getElementById('blue-y').value),
                    max: parseFloat(document.getElementById('blue-max').value)
                },
                target: {
                    x: parseFloat(document.getElementById('target-x').value),
                    y: parseFloat(document.getElementById('target-y').value)
                }
            };
            
            // éªŒè¯è¾“å…¥
            if (!validateInput(data)) {
                return;
            }
            
            // å¼€å§‹é€æ­¥è®¡ç®—
            setTimeout(() => step2_calculateZ(data), 100);
        }
        
        function validateInput(data) {
            // æ£€æŸ¥æ˜¯å¦æœ‰ç©ºå€¼
            for (let color in data) {
                for (let prop in data[color]) {
                    if (isNaN(data[color][prop])) {
                        showError('è¯·å¡«å†™æ‰€æœ‰è¾“å…¥é¡¹ï¼');
                        return false;
                    }
                }
            }
            
            // æ£€æŸ¥åæ ‡èŒƒå›´
            for (let color in data) {
                if (data[color].x < 0 || data[color].x > 1 || data[color].y < 0 || data[color].y > 1) {
                    showError('è‰²åæ ‡å¿…é¡»åœ¨0åˆ°1ä¹‹é—´ï¼');
                    return false;
                }
            }
            
            // æ£€æŸ¥yåæ ‡ä¸ä¸º0
            for (let color in data) {
                if (data[color].y <= 0) {
                    showError('yåæ ‡ä¸èƒ½ä¸º0æˆ–è´Ÿæ•°ï¼');
                    return false;
                }
            }
            
            // æ£€æŸ¥æœ€å¤§å…‰é€šé‡
            if (data.red.max <= 0 || data.green.max <= 0 || data.blue.max <= 0) {
                showError('æœ€å¤§å…‰é€šé‡å¿…é¡»å¤§äº0ï¼');
                return false;
            }
            
            return true;
        }
        
        function showError(message) {
            const errorBox = document.getElementById('error-message');
            errorBox.textContent = message;
            errorBox.style.display = 'block';
        }
        
        function step2_calculateZ(data) {
            document.getElementById('step2').classList.add('active');
            
            // è®¡ç®—zåæ ‡
            data.red.z = 1 - data.red.x - data.red.y;
            data.green.z = 1 - data.green.x - data.green.y;
            data.blue.z = 1 - data.blue.x - data.blue.y;
            data.target.z = 1 - data.target.x - data.target.y;
            
            // æ˜¾ç¤ºè®¡ç®—ç»“æœ
            const zCalc = document.getElementById('z-calculations');
            zCalc.innerHTML = `
                <div>çº¢è‰²ï¼šz<sub>r</sub> = 1 - ${data.red.x.toFixed(4)} - ${data.red.y.toFixed(4)} = <span class="highlight">${data.red.z.toFixed(4)}</span></div>
                <div>ç»¿è‰²ï¼šz<sub>g</sub> = 1 - ${data.green.x.toFixed(4)} - ${data.green.y.toFixed(4)} = <span class="highlight">${data.green.z.toFixed(4)}</span></div>
                <div>è“è‰²ï¼šz<sub>b</sub> = 1 - ${data.blue.x.toFixed(4)} - ${data.blue.y.toFixed(4)} = <span class="highlight">${data.blue.z.toFixed(4)}</span></div>
                <div>ç›®æ ‡è‰²ï¼šz<sub>t</sub> = 1 - ${data.target.x.toFixed(4)} - ${data.target.y.toFixed(4)} = <span class="highlight">${data.target.z.toFixed(4)}</span></div>
            `;
            
            setTimeout(() => step3_buildEquations(data), 1000);
        }
        
        function step3_buildEquations(data) {
            document.getElementById('step3').classList.add('active');
            
            // æ„å»ºç³»æ•°çŸ©é˜µ
            const A = [
                [data.red.x / data.red.y, data.green.x / data.green.y, data.blue.x / data.blue.y],
                [1, 1, 1],
                [data.red.z / data.red.y, data.green.z / data.green.y, data.blue.z / data.blue.y]
            ];
            
            const b = [
                data.target.x / data.target.y,
                1,
                data.target.z / data.target.y
            ];
            
            // æ˜¾ç¤ºçŸ©é˜µæ–¹ç¨‹
            const matrixEq = document.getElementById('matrix-equation');
            matrixEq.innerHTML = `
                <div style="text-align: center;">
                    <div class="matrix">
                        <span class="matrix-bracket">[</span>
                        <div class="matrix-content">
                            <div class="matrix-row">
                                <span class="matrix-cell">${A[0][0].toFixed(3)}</span>
                                <span class="matrix-cell">${A[0][1].toFixed(3)}</span>
                                <span class="matrix-cell">${A[0][2].toFixed(3)}</span>
                            </div>
                            <div class="matrix-row">
                                <span class="matrix-cell">${A[1][0].toFixed(3)}</span>
                                <span class="matrix-cell">${A[1][1].toFixed(3)}</span>
                                <span class="matrix-cell">${A[1][2].toFixed(3)}</span>
                            </div>
                            <div class="matrix-row">
                                <span class="matrix-cell">${A[2][0].toFixed(3)}</span>
                                <span class="matrix-cell">${A[2][1].toFixed(3)}</span>
                                <span class="matrix-cell">${A[2][2].toFixed(3)}</span>
                            </div>
                        </div>
                        <span class="matrix-bracket">]</span>
                    </div>
                    Ã—
                    <div class="matrix">
                        <span class="matrix-bracket">[</span>
                        <div class="matrix-content">
                            <div class="matrix-row"><span class="matrix-cell">r</span></div>
                            <div class="matrix-row"><span class="matrix-cell">g</span></div>
                            <div class="matrix-row"><span class="matrix-cell">b</span></div>
                        </div>
                        <span class="matrix-bracket">]</span>
                    </div>
                    =
                    <div class="matrix">
                        <span class="matrix-bracket">[</span>
                        <div class="matrix-content">
                            <div class="matrix-row"><span class="matrix-cell">${b[0].toFixed(3)}</span></div>
                            <div class="matrix-row"><span class="matrix-cell">${b[1].toFixed(3)}</span></div>
                            <div class="matrix-row"><span class="matrix-cell">${b[2].toFixed(3)}</span></div>
                        </div>
                        <span class="matrix-bracket">]</span>
                    </div>
                </div>
                <div style="margin-top: 15px; text-align: center; color: #7f8c8d;">
                    å…¶ä¸­ r, g, b æ˜¯çº¢ã€ç»¿ã€è“ä¸‰åŸºè‰²çš„å…‰é€šé‡æ¯”ä¾‹ï¼ˆæ€»å’Œä¸º1ï¼‰
                </div>
            `;
            
            // ä¿å­˜æ•°æ®ä¾›ä¸‹ä¸€æ­¥ä½¿ç”¨
            data.A = A;
            data.b = b;
            
            setTimeout(() => step4_solveEquations(data), 1500);
        }
        
        function step4_solveEquations(data) {
            document.getElementById('step4').classList.add('active');
            
            try {
                // æ±‚è§£çº¿æ€§æ–¹ç¨‹ç»„
                const solution = solveLinearSystem(data.A, data.b);
                
                // æ£€æŸ¥è§£çš„æœ‰æ•ˆæ€§
                if (solution[0] < 0 || solution[1] < 0 || solution[2] < 0) {
                    showError('ç›®æ ‡è‰²åœ¨RGBä¸‰è§’å½¢å¤–éƒ¨ï¼Œæ— æ³•é€šè¿‡RGBæ··åˆå¾—åˆ°ï¼');
                    document.getElementById('solution-result').innerHTML = 
                        '<span class="warning">è®¡ç®—å¾—åˆ°è´Ÿå€¼ï¼Œè¡¨ç¤ºç›®æ ‡è‰²æ— æ³•å®ç°</span>';
                    return;
                }
                
                // æ˜¾ç¤ºæ±‚è§£è¿‡ç¨‹
                document.getElementById('gaussian-steps').innerHTML = `
                    <div>ä½¿ç”¨é«˜æ–¯æ¶ˆå…ƒæ³•æ±‚è§£...</div>
                    <div style="margin-top: 10px;">ç»è¿‡è¡Œå˜æ¢å’Œå›ä»£ï¼Œå¾—åˆ°è§£ï¼š</div>
                `;
                
                // æ˜¾ç¤ºè§£
                document.getElementById('solution-result').innerHTML = `
                    <div>çº¢è‰²æ¯”ä¾‹ r = <span class="highlight">${solution[0].toFixed(4)}</span></div>
                    <div>ç»¿è‰²æ¯”ä¾‹ g = <span class="highlight">${solution[1].toFixed(4)}</span></div>
                    <div>è“è‰²æ¯”ä¾‹ b = <span class="highlight">${solution[2].toFixed(4)}</span></div>
                    <div style="margin-top: 10px;">éªŒè¯ï¼šr + g + b = ${(solution[0] + solution[1] + solution[2]).toFixed(4)} â‰ˆ 1.000 âœ“</div>
                `;
                
                // ä¿å­˜è§£
                data.ratios = {
                    red: solution[0],
                    green: solution[1],
                    blue: solution[2]
                };
                
                setTimeout(() => step5_calculateScaling(data), 1500);
                
            } catch (error) {
                showError('æ–¹ç¨‹ç»„æ±‚è§£å¤±è´¥ï¼š' + error.message);
            }
        }
        
        function step5_calculateScaling(data) {
            document.getElementById('step5').classList.add('active');
            
            // è®¡ç®—ç¼©æ”¾å› å­
            const scaleFactors = {
                red: data.red.max / data.ratios.red,
                green: data.green.max / data.ratios.green,
                blue: data.blue.max / data.ratios.blue
            };
            
            // æ‰¾å‡ºæœ€å°ç¼©æ”¾å› å­
            let minScale = Math.min(scaleFactors.red, scaleFactors.green, scaleFactors.blue);
            let limitingColor = '';
            
            if (minScale === scaleFactors.red) limitingColor = 'çº¢è‰²';
            else if (minScale === scaleFactors.green) limitingColor = 'ç»¿è‰²';
            else limitingColor = 'è“è‰²';
            
            // æ˜¾ç¤ºç¼©æ”¾å› å­è®¡ç®—
            document.getElementById('scale-factors').innerHTML = `
                <div>çº¢è‰²ç¼©æ”¾å› å­ï¼šk<sub>r</sub> = ${data.red.max} Ã· ${data.ratios.red.toFixed(4)} = <span class="highlight">${scaleFactors.red.toFixed(2)}</span></div>
                <div>ç»¿è‰²ç¼©æ”¾å› å­ï¼šk<sub>g</sub> = ${data.green.max} Ã· ${data.ratios.green.toFixed(4)} = <span class="highlight">${scaleFactors.green.toFixed(2)}</span></div>
                <div>è“è‰²ç¼©æ”¾å› å­ï¼šk<sub>b</sub> = ${data.blue.max} Ã· ${data.ratios.blue.toFixed(4)} = <span class="highlight">${scaleFactors.blue.toFixed(2)}</span></div>
            `;
            
            // æ˜¾ç¤ºé™åˆ¶å› å­
            document.getElementById('limiting-factor').innerHTML = `
                <div>æœ€å°ç¼©æ”¾å› å­ï¼š<span class="highlight">${minScale.toFixed(2)}</span></div>
                <div>é™åˆ¶å› å­ï¼š<span class="warning">${limitingColor}</span>å°†é¦–å…ˆè¾¾åˆ°å…¶æœ€å¤§å€¼</div>
            `;
            
            // ä¿å­˜ç»“æœ
            data.minScale = minScale;
            data.limitingColor = limitingColor;
            
            setTimeout(() => step6_showResults(data), 1500);
        }
        
        function step6_showResults(data) {
            document.getElementById('step6').classList.add('active');
            
            // è®¡ç®—æœ€ç»ˆç»“æœ
            const maxLuminance = data.minScale;
            const usage = {
                red: data.ratios.red * data.minScale,
                green: data.ratios.green * data.minScale,
                blue: data.ratios.blue * data.minScale
            };
            
            // æ˜¾ç¤ºæœ€å¤§å…‰é€šé‡
            document.getElementById('max-luminance').innerHTML = `
                ç›®æ ‡è‰²èƒ½è¾¾åˆ°çš„æœ€å¤§æ€»å…‰é€šé‡ï¼š<span class="highlight" style="font-size: 24px;">${maxLuminance.toFixed(2)}</span>
            `;
            
            // å¡«å……ä½¿ç”¨é‡è¡¨æ ¼
            const tbody = document.getElementById('usage-tbody');
            tbody.innerHTML = `
                <tr>
                    <td style="color: #e74c3c; font-weight: bold;">çº¢è‰²</td>
                    <td>${data.ratios.red.toFixed(4)}</td>
                    <td>${usage.red.toFixed(2)}</td>
                    <td>${data.red.max}</td>
                    <td>${(usage.red / data.red.max * 100).toFixed(1)}%</td>
                </tr>
                <tr>
                    <td style="color: #27ae60; font-weight: bold;">ç»¿è‰²</td>
                    <td>${data.ratios.green.toFixed(4)}</td>
                    <td>${usage.green.toFixed(2)}</td>
                    <td>${data.green.max}</td>
                    <td>${(usage.green / data.green.max * 100).toFixed(1)}%</td>
                </tr>
                <tr>
                    <td style="color: #3498db; font-weight: bold;">è“è‰²</td>
                    <td>${data.ratios.blue.toFixed(4)}</td>
                    <td>${usage.blue.toFixed(2)}</td>
                    <td>${data.blue.max}</td>
                    <td>${(usage.blue / data.blue.max * 100).toFixed(1)}%</td>
                </tr>
            `;
            
            // æ˜¾ç¤ºç»“è®º
            document.getElementById('conclusion').innerHTML = `
                <div class="success">
                    åœ¨ç»™å®šçš„RGBæœ€å¤§å…‰é€šé‡é™åˆ¶ä¸‹ï¼Œç›®æ ‡è‰²(${data.target.x.toFixed(3)}, ${data.target.y.toFixed(3)})
                    èƒ½å¤Ÿè¾¾åˆ°çš„æœ€å¤§å…‰é€šé‡ä¸º ${maxLuminance.toFixed(2)}ã€‚
                </div>
                <div style="margin-top: 10px;">
                    ${data.limitingColor}è¾¾åˆ°äº†å…¶æœ€å¤§å€¼ ${data[data.limitingColor.replace('è‰²', '')].max}ï¼Œ
                    æˆä¸ºé™åˆ¶å› ç´ ã€‚å¦‚æœæƒ³è¦æ›´é«˜çš„æ€»å…‰é€šé‡ï¼Œéœ€è¦æé«˜${data.limitingColor}çš„æœ€å¤§å…‰é€šé‡é™åˆ¶ã€‚
                </div>
            `;
        }
        
        // æ±‚è§£çº¿æ€§æ–¹ç¨‹ç»„çš„å‡½æ•°
        function solveLinearSystem(A, b) {
            const n = A.length;
            
            // åˆ›å»ºå¢å¹¿çŸ©é˜µ
            const augmented = [];
            for (let i = 0; i < n; i++) {
                augmented.push([...A[i], b[i]]);
            }
            
            // é«˜æ–¯æ¶ˆå…ƒ
            for (let i = 0; i < n; i++) {
                // æ‰¾ä¸»å…ƒ
                let maxRow = i;
                for (let k = i + 1; k < n; k++) {
                    if (Math.abs(augmented[k][i]) > Math.abs(augmented[maxRow][i])) {
                        maxRow = k;
                    }
                }
                
                // äº¤æ¢è¡Œ
                [augmented[i], augmented[maxRow]] = [augmented[maxRow], augmented[i]];
                
                // æ£€æŸ¥ä¸»å…ƒæ˜¯å¦ä¸º0
                if (Math.abs(augmented[i][i]) < 1e-10) {
                    throw new Error('çŸ©é˜µå¥‡å¼‚ï¼Œæ— æ³•æ±‚è§£');
                }
                
                // æ¶ˆå…ƒ
                for (let k = i + 1; k < n; k++) {
                    const factor = augmented[k][i] / augmented[i][i];
                    for (let j = i; j <= n; j++) {
                        augmented[k][j] -= factor * augmented[i][j];
                    }
                }
            }
            
            // å›ä»£
            const x = new Array(n);
            for (let i = n - 1; i >= 0; i--) {
                x[i] = augmented[i][n];
                for (let j = i + 1; j < n; j++) {
                    x[i] -= augmented[i][j] * x[j];
                }
                x[i] /= augmented[i][i];
            }
            
            return x;
        }
    </script>
</body>
</html>
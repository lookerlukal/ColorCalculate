<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>色彩合成计算器</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- SheetJS库用于Excel文件处理 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>色彩合成计算器</h1>
        
        <div class="main-content">
            <div class="color-chart">
                <canvas id="cie1931" width="600" height="600"></canvas>
                <div class="chart-help">
                    <small>💡 操作提示：鼠标滚轮缩放，拖拽颜色点移动，按R键重置缩放，按D键开启调试模式，右上角LOG查看调试日志</small>
                </div>
                <div class="chart-controls">
                    <label class="checkbox-label">
                        <input type="checkbox" id="show-srgb-gamut" checked>
                        <span>sRGB色域</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="show-ntsc-gamut" checked>
                        <span>NTSC色域</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="show-ledbin-gamut">
                        <span>LED BIN最小色域</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="show-precise-gamut">
                        <span>精确交集色域（计算密集）</span>
                    </label>
                </div>
            </div>
            
            <div class="control-panel">
                <div class="tabs">
                    <button id="tab1" class="tab-btn active">Step 1: 计算混合结果</button>
                    <button id="tab2" class="tab-btn">Step 2: 目标色导入</button>
                    <button id="tab3" class="tab-btn">Step 3: 计算光通量需求</button>
                </div>
                
                <div id="mode1" class="tab-content active">
                    <h2>RGB三基色输入</h2>
                    <div class="color-inputs">
                        <div class="color-input red">
                            <h3>红色 (R)</h3>
                            <div class="input-group">
                                <label>x坐标:</label>
                                <input type="number" id="red-x" step="0.0001" min="0" max="1" value="0.7000" inputmode="decimal">
                            </div>
                            <div class="input-group">
                                <label>y坐标:</label>
                                <input type="number" id="red-y" step="0.0001" min="0" max="1" value="0.3000" inputmode="decimal">
                            </div>
                            <div class="input-group">
                                <label>光通量 (Lv):</label>
                                <input type="number" id="red-lv" step="0.0001" min="0" value="10.0000" inputmode="decimal">
                            </div>
                            
                            <!-- LED分BIN选择器 -->
                            <div class="led-bin-selector" id="red-led-selector">
                                <div class="led-enable-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="red-led-enable">
                                        <span>OSRAM_LRTB GVSR</span>
                                    </label>
                                </div>
                                <div class="led-selection-group" style="display: none;">
                                    <div class="led-bin-group">
                                        <label>亮度BIN:</label>
                                        <select id="red-luminance-bin" class="led-select">
                                            <option value="">选择亮度BIN...</option>
                                        </select>
                                    </div>
                                    <div class="led-bin-group">
                                        <label>色度BIN:</label>
                                        <select id="red-color-bin" class="led-select">
                                            <option value="">选择色度BIN...</option>
                                        </select>
                                    </div>
                                    <div class="led-info" id="red-led-info" style="display: none;">
                                        <small class="led-wavelength-info"></small>
                                    </div>
                                </div>
                            </div>
                            
                        </div>
                        
                        <div class="color-input green">
                            <h3>绿色 (G)</h3>
                            <div class="input-group">
                                <label>x坐标:</label>
                                <input type="number" id="green-x" step="0.0001" min="0" max="1" value="0.2000" inputmode="decimal">
                            </div>
                            <div class="input-group">
                                <label>y坐标:</label>
                                <input type="number" id="green-y" step="0.0001" min="0" max="1" value="0.7000" inputmode="decimal">
                            </div>
                            <div class="input-group">
                                <label>光通量 (Lv):</label>
                                <input type="number" id="green-lv" step="0.0001" min="0" value="10.0000" inputmode="decimal">
                            </div>
                            
                            <!-- LED分BIN选择器 -->
                            <div class="led-bin-selector" id="green-led-selector">
                                <div class="led-enable-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="green-led-enable">
                                        <span>OSRAM_LRTB GVSR</span>
                                    </label>
                                </div>
                                <div class="led-selection-group" style="display: none;">
                                    <div class="led-bin-group">
                                        <label>亮度BIN:</label>
                                        <select id="green-luminance-bin" class="led-select">
                                            <option value="">选择亮度BIN...</option>
                                        </select>
                                    </div>
                                    <div class="led-bin-group">
                                        <label>色度BIN:</label>
                                        <select id="green-color-bin" class="led-select">
                                            <option value="">选择色度BIN...</option>
                                        </select>
                                    </div>
                                    <div class="led-info" id="green-led-info" style="display: none;">
                                        <small class="led-wavelength-info"></small>
                                    </div>
                                </div>
                            </div>
                            
                        </div>
                        
                        <div class="color-input blue">
                            <h3>蓝色 (B)</h3>
                            <div class="input-group">
                                <label>x坐标:</label>
                                <input type="number" id="blue-x" step="0.0001" min="0" max="1" value="0.1000" inputmode="decimal">
                            </div>
                            <div class="input-group">
                                <label>y坐标:</label>
                                <input type="number" id="blue-y" step="0.0001" min="0" max="1" value="0.1000" inputmode="decimal">
                            </div>
                            <div class="input-group">
                                <label>光通量 (Lv):</label>
                                <input type="number" id="blue-lv" step="0.0001" min="0" value="10.0000" inputmode="decimal">
                            </div>
                            
                            <!-- LED分BIN选择器 -->
                            <div class="led-bin-selector" id="blue-led-selector">
                                <div class="led-enable-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="blue-led-enable">
                                        <span>OSRAM_LRTB GVSR</span>
                                    </label>
                                </div>
                                <div class="led-selection-group" style="display: none;">
                                    <div class="led-bin-group">
                                        <label>亮度BIN:</label>
                                        <select id="blue-luminance-bin" class="led-select">
                                            <option value="">选择亮度BIN...</option>
                                        </select>
                                    </div>
                                    <div class="led-bin-group">
                                        <label>色度BIN:</label>
                                        <select id="blue-color-bin" class="led-select">
                                            <option value="">选择色度BIN...</option>
                                        </select>
                                    </div>
                                    <div class="led-info" id="blue-led-info" style="display: none;">
                                        <small class="led-wavelength-info"></small>
                                    </div>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                    
                    <button id="calculate-mix" class="calc-btn">计算混合结果</button>
                    
                    <div class="result">
                        <h3>计算结果</h3>
                        <div class="result-item">
                            <span>合成色 x 坐标:</span>
                            <span id="mix-x">-</span>
                        </div>
                        <div class="result-item">
                            <span>合成色 y 坐标:</span>
                            <span id="mix-y">-</span>
                        </div>
                        <div class="result-item">
                            <span>合成色光通量:</span>
                            <span id="mix-lv">-</span>
                        </div>
                    </div>
                </div>
                
                <div id="mode2" class="tab-content">
                    <div class="title-with-button">
                        <h2>目标色导入</h2>
                        <input type="file" id="excel-file-input" accept=".xlsx,.xls" style="display: none;">
                        <button id="select-excel-btn" class="upload-btn compact">选择EXCEL</button>
                    </div>
                    
                    
                    <!-- LED BIN色域边界检测 -->
                    <div class="title-with-button">
                        <h3>LED BIN色域边界检测</h3>
                        <button id="check-gamut-boundary" class="gamut-btn" disabled>
                            判断是否超色域边界
                        </button>
                    </div>
                    
                    <div class="excel-table-section">
                        <h3>颜色数据表</h3>
                        <div id="color-table-container">
                            <!-- 表格将由ColorTable组件动态生成 -->
                        </div>
                    </div>
                </div>
                
                <div id="mode3" class="tab-content">
                    <h2>计算光通量需求</h2>
                    
                    <div class="target-color-selection">
                        <h3>目标色选择</h3>
                        
                        <!-- 手动输入目标色 -->
                        <div class="manual-target-input">
                            <h4>手动输入目标色</h4>
                            <div class="input-group">
                                <label>目标色 x 坐标:</label>
                                <input type="number" id="manual-target-x" step="0.0001" min="0" max="1" value="0.3333" inputmode="decimal">
                            </div>
                            <div class="input-group">
                                <label>目标色 y 坐标:</label>
                                <input type="number" id="manual-target-y" step="0.0001" min="0" max="1" value="0.3333" inputmode="decimal">
                            </div>
                            <div class="input-group">
                                <label>目标光通量 (Lv):</label>
                                <input type="number" id="manual-target-lv" step="0.0001" min="0" value="1.0000" inputmode="decimal">
                                <span class="max-lv-hint" id="manual-max-lv-hint">最大可达: 计算中...</span>
                            </div>
                            <button id="add-manual-target" class="upload-btn">添加到目标列表</button>
                        </div>
                        
                        <!-- 从Excel数据选择 -->
                        <div class="excel-target-selection">
                            <h4>从Excel数据选择</h4>
                            <div class="input-group">
                                <label>颜色:</label>
                                <select id="excel-target-selector" class="preset-select">
                                    <option value="">请先导入Excel数据...</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>目标光通量 (Lv):</label>
                                <input type="number" id="excel-target-lv" step="0.0001" min="0" value="1.0000" inputmode="decimal">
                                <span class="max-lv-hint" id="excel-max-lv-hint">最大可达: 计算中...</span>
                            </div>
                            <button id="add-excel-target" class="upload-btn">添加到目标列表</button>
                        </div>
                        
                        <!-- 已选目标色列表 -->
                        <div class="selected-targets">
                            <h4>已选目标色</h4>
                            <div id="target-list" class="target-list">
                                <p class="empty-hint">尚未添加任何目标色</p>
                            </div>
                            <button id="clear-all-targets" class="clear-btn">清空所有目标</button>
                        </div>
                    </div>
                    
                    <p class="mode-note">注意：RGB三基色坐标使用模式1中的设置</p>
                    
                    <div class="calc-btn-group">
                        <button id="calculate-lv" class="calc-btn calc-btn-left">按设定值计算</button>
                        <button id="calculate-lv-max" class="calc-btn calc-btn-right">按最大值计算</button>
                    </div>
                    
                    <div class="result">
                        <h3>计算结果</h3>
                        <div id="mode3-results">
                            <p class="empty-hint">请先添加目标色并点击计算</p>
                        </div>
                    </div>
                </div>
                
                <div id="mode4" class="tab-content" style="display: none;">
                    <h2>计算最大光通量</h2>
                    <p class="mode-note">RGB三基色坐标使用模式1中的设置，此处仅设置各基色的最大光通量</p>
                    <div class="color-inputs">
                        <div class="color-input red">
                            <h3>红色 (R)</h3>
                            <div class="input-group">
                                <label>最大光通量:</label>
                                <input type="number" id="red-max-lv" step="0.0001" min="0" value="100.0000" inputmode="decimal">
                            </div>
                        </div>
                        
                        <div class="color-input green">
                            <h3>绿色 (G)</h3>
                            <div class="input-group">
                                <label>最大光通量:</label>
                                <input type="number" id="green-max-lv" step="0.0001" min="0" value="100.0000" inputmode="decimal">
                            </div>
                        </div>
                        
                        <div class="color-input blue">
                            <h3>蓝色 (B)</h3>
                            <div class="input-group">
                                <label>最大光通量:</label>
                                <input type="number" id="blue-max-lv" step="0.0001" min="0" value="100.0000" inputmode="decimal">
                            </div>
                        </div>
                    </div>
                    
                    <p class="mode-note">注意：目标色坐标使用模式2中的设置</p>
                    
                    <button id="calculate-max-lv" class="calc-btn">计算最大光通量</button>
                    
                    <div class="result">
                        <h3>计算结果</h3>
                        <div class="result-item">
                            <span>最大可达光通量:</span>
                            <span id="max-lv-result">-</span>
                        </div>
                        <div class="result-item">
                            <span>限制因子:</span>
                            <span id="limiting-color">-</span>
                        </div>
                        <div class="result-item">
                            <span>红色使用量:</span>
                            <span id="red-used-lv">-</span>
                        </div>
                        <div class="result-item">
                            <span>绿色使用量:</span>
                            <span id="green-used-lv">-</span>
                        </div>
                        <div class="result-item">
                            <span>蓝色使用量:</span>
                            <span id="blue-used-lv">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Core modules (load in order) -->
    <script src="js/config.js"></script>
    <script src="js/led-bin-manager.js"></script>
    <script src="js/logger.js"></script>
    <script src="js/notification.js"></script>
    <script src="js/xyz-calculator.js"></script>
    <script src="js/color-calculator.js"></script>
    <script src="js/chart-renderer.js"></script>
    <script src="js/excel-loader.js"></script>
    <script src="js/color-table.js"></script>
    <script src="js/app-controller.js"></script>
    <script src="js/script.js"></script>
    <script src="js/debug.js"></script>
    <script src="test-console.js"></script>
    
    <!-- Excel数据统计弹窗 -->
    <div id="excel-stats-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Excel数据导入成功</h3>
            </div>
            <div class="modal-body">
                <div class="stats-grid" id="excel-stats-content">
                    <!-- 动态填充统计信息 -->
                </div>
            </div>
            <div class="modal-footer">
                <button id="excel-stats-confirm" class="modal-btn">确认</button>
            </div>
        </div>
    </div>
    
    <!-- 色域检测结果弹窗 -->
    <div id="gamut-check-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>色域边界检测结果</h3>
            </div>
            <div class="modal-body">
                <div class="gamut-check-content" id="gamut-check-content">
                    <!-- 动态填充检测结果 -->
                </div>
            </div>
            <div class="modal-footer">
                <button id="gamut-check-confirm" class="modal-btn">确认</button>
            </div>
        </div>
    </div>
</body>
</html> 